<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Ü–µ—Ä—Ç—ã ‚Äî –ê–¥–º–∏–Ω–∫–∞</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        body { background: #f6f7fb; font-family: 'Segoe UI', 'Arial', sans-serif; }
        .admin-container { max-width: 1200px; margin: 40px auto; padding: 30px; background: white; border-radius: 18px; box-shadow: 0 8px 32px rgba(60,60,120,0.08); }
        .admin-header { display: flex; align-items: center; justify-content: space-between; gap: 24px; margin-bottom: 30px; }
        .admin-header h1 { font-size: 2.2em; margin: 0; flex-shrink:0; }
        .admin-nav-flex { display: flex; gap: 18px; flex-wrap: nowrap; align-items: center; position: relative; overflow-x: auto; padding-bottom: 4px; flex:1; }
        .admin-menu-btn { background: #667eea; color: white; padding: 10px 28px; border-radius: 10px; text-decoration: none; font-weight: 500; font-size: 1.08em; border: none; transition: background 0.18s, color 0.18s; display: inline-block; text-align: center; cursor: pointer; white-space: nowrap; }
        .admin-menu-btn:hover, .admin-menu-btn.active { background: #4f5bd5; color: #fff; }
        /* –£–¥–∞–ª–µ–Ω—ã —Å—Ç–∏–ª–∏ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –º–µ–Ω—é, —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—â–∏–π style.css */
        .admin-menu-dropdown-arrow { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); width: 24px; height: 12px; pointer-events: none; z-index: 1003; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px);} to { opacity: 1; transform: translateY(0);} }
        /* –£–¥–∞–ª–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —Å—Ç–∏–ª–∏ —Ç–∞–±–ª–∏—Ü—ã –Ω–∏–∂–µ */
        /* –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è .fill-bar: –æ—Ç –∫—Ä–∞—Å–Ω–æ–≥–æ –∫ –∑–µ–ª—ë–Ω–æ–º—É */
        .fill-bar {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-width: 60px;
            padding: 2px 8px 6px 8px;
            border-radius: 8px;
            font-weight: 600;
            color: #fff;
            text-align: left;
            position: relative;
            background: none;
            box-shadow: none;
        }
        .fill-bar .fill-percent {
            z-index: 2;
            font-size: 1em;
            margin-bottom: 2px;
        }
        .fill-bar .fill-progress {
            width: 100%;
            height: 6px;
            border-radius: 4px;
            background: #e0e7ff;
            overflow: hidden;
            margin-top: 2px;
            position: relative;
        }
        .fill-bar .fill-progress-inner {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, #e53935 0%, #ffeb3b 50%, #34c759 100%);
            transition: width 0.3s;
        }

        /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–æ–Ω fill-bar */

        /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ç—ë–º–Ω–æ–≥–æ —Ñ–æ–Ω–∞ */
        .fill-bar .fill-percent {
            color: #222;
            font-weight: 700;
        }
        .fill-bar::after { content: attr(data-tooltip); position: absolute; top: 120%; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 8px 14px; border-radius: 8px; font-size: 13px; white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1001; margin-top: 6px; pointer-events: none; box-shadow: 0 4px 16px rgba(0,0,0,0.18); }
        .fill-bar:hover::after { opacity: 1; visibility: visible; }
        .hall-badge { display: inline-block; background: #e3f2fd; color: #1976d2; border-radius: 8px; padding: 4px 14px; font-size: 1em; font-weight: 400; margin: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 30px; background: #f8f9fa; border-radius: 12px; overflow: hidden; }
        th, td { padding: 14px 10px; text-align: left; }
        th { background: #e0e7ff; color: #333; font-weight: 600; }
        tr:nth-child(even) { background: #f0f4ff; }
        tr:hover { background: #e3eafe; }
        th.sortable { cursor: pointer; user-select: none; position: relative; transition: background 0.15s, color 0.15s; }
        th.sortable:hover { background: #dbeafe; color: #4f5bd5; }
        th.sortable:after { content: ''; position: absolute; right: 10px; font-size: 1em; }
        th.sorted-asc:after { content: '‚ñ≤'; }
        th.sorted-desc:after { content: '‚ñº'; }
        .available-icon, .unavailable-icon {
            display: inline-flex;
            align-items: center;
            vertical-align: middle;
            margin-right: 2px;
        }
        .available-icon svg, .unavailable-icon svg {
            width: 28px;
            height: 28px;
            display: block;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>–ö–æ–Ω—Ü–µ—Ä—Ç—ã</h1>
            <nav class="admin-nav-flex" id="adminNav" style="flex:1;">
                <a href="/admin" class="admin-menu-btn">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="/admin/users" class="admin-menu-btn">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
                <a href="/admin/customers" class="admin-menu-btn">–ü–æ–∫—É–ø–∞—Ç–µ–ª–∏</a>
                <a href="/admin/purchases" class="admin-menu-btn">–ü–æ–∫—É–ø–∫–∏</a>
                <a href="/admin/concerts" class="admin-menu-btn">–ö–æ–Ω—Ü–µ—Ä—Ç—ã</a>
                <a href="/admin/halls" class="admin-menu-btn">–ó–∞–ª—ã</a>
                <a href="/" class="admin-menu-btn"><span style="font-size:1.1em; margin-right:6px;">ÔøΩÔøΩ</span>–ù–∞ —Å–∞–π—Ç</a>
                <div class="admin-menu-dropdown" id="adminMenuDropdown" style="display:none;">
                    <button class="admin-menu-dropdown-btn" id="dropdownBtn">–ï—â—ë <span style="font-size:1.1em;">‚ñº</span></button>
                    <div class="admin-menu-dropdown-content" id="dropdownContent">
                        <div class="admin-menu-dropdown-arrow">
                            <svg width="24" height="12"><polygon points="12,12 0,0 24,0" fill="#f0f4ff"/></svg>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
        <!-- –§–∏–ª—å—Ç—Ä—ã –ø–æ –¥–Ω—è–º -->
        <div class="filter-block" id="day-filters" style="margin-bottom: 18px; display: flex; align-items: center; gap: 18px; background: #f4f6fb; border-radius: 12px; padding: 14px 24px;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                {% set month_names = ['—è–Ω–≤–∞—Ä—è','—Ñ–µ–≤—Ä–∞–ª—è','–º–∞—Ä—Ç–∞','–∞–ø—Ä–µ–ª—è','–º–∞—è','–∏—é–Ω—è','–∏—é–ª—è','–∞–≤–≥—É—Å—Ç–∞','—Å–µ–Ω—Ç—è–±—Ä—è','–æ–∫—Ç—è–±—Ä—è','–Ω–æ—è–±—Ä—è','–¥–µ–∫–∞–±—Ä—è'] %}
                {% for day in concert_days %}
                    <a href="#" class="day-filter-link" data-day="{{ day.isoformat() }}" style="display:inline-block; padding:7px 18px; border-radius:8px; background:#e0e7ff; color:#4f5bd5; font-weight:500; text-decoration:none; font-size:1.05em; transition:background 0.15s, color 0.15s;">{{ day.day }} {{ month_names[day.month-1] }}</a>
                {% endfor %}
            </div>
            <button id="reset-day-filter" type="button" style="height:38px; width:38px; display:flex; align-items:center; justify-content:center; border:none; border-radius:50%; background:#e0e7ff; color:#4f5bd5; font-size:1.3em; margin-left:10px; box-shadow:0 2px 8px rgba(102,126,234,0.07); cursor:pointer; transition:background 0.2s;" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–Ω—é">
                &#8635;
            </button>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin: 8px 0 0 0;">
            <div>
                <button id="refresh-tickets-btn" style="padding: 8px 16px; background: #4f5bd5; color: white; border: none; border-radius: 8px; font-size: 0.9em; cursor: pointer; transition: background 0.2s;" title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –±–∏–ª–µ—Ç–∞—Ö">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å –±–∏–ª–µ—Ç—ã
                </button>
                <span id="refresh-status" style="margin-left: 12px; font-size: 0.9em; color: #666;"></span>
            </div>
            <div style="color: #aaa; font-size: 0.98em; text-align: right;">
                –ü–æ–∫–∞–∑–∞–Ω–æ –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤: <span id="concerts-count-value">{{ concerts_data|length }}</span>
                <span id="filter-available" style="margin-left: 18px; color: #aaa; font-weight: 500; cursor:pointer; user-select:none;">
                    –î–æ—Å—Ç—É–ø–Ω–æ –∫ –ø—Ä–æ–¥–∞–∂–µ: <span style="color:#388e3c; font-weight: 600;">{{ available_count }}</span>
                </span>
                <span id="filter-unavailable" style="margin-left: 12px; color: #aaa; font-weight: 500; cursor:pointer; user-select:none;">
                    –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ: <span style="color:#e53935; font-weight: 600;">{{ unavailable_count }}</span>
                </span>
            </div>
        </div>
        <table id="concerts-table">
            <thead>
                <tr>
                    <th class="sortable" colspan="2">–ö–æ–Ω—Ü–µ—Ä—Ç</th>
                    <th class="sortable">–ó–∞–ª</th>
                    <th class="sortable">–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å</th>
                    <th class="sortable">–î–æ—Å—Ç—É–ø–Ω–æ</th>
                </tr>
            </thead>
            <tbody>
                {% for item in concerts_data %}
                <tr>
                    <td colspan="2">
                        <div class="concert-title-flex">
                            {% set concert = item.concert %}
                            {% set day = 1 %}
                            {% if concert.datetime %}
                                {% set day = concert.datetime.day %}
                                {% if day > 7 %}{% set day = 7 %}{% endif %}
                                {% if day < 1 %}{% set day = 1 %}{% endif %}
                            {% endif %}
                            <span class="concert-number concert-number-day{{ day }}">{{ concert.id }}</span>
                            <span class="concert-title-text">
                                {{ concert.name }}
                                {% if concert.datetime %}
                                    <span class="concert-date-text" data-day="{{ concert.datetime.date().isoformat() }}">
                                        {{ concert.datetime.day }}
                                        {% set month_names = ['—è–Ω–≤–∞—Ä—è','—Ñ–µ–≤—Ä–∞–ª—è','–º–∞—Ä—Ç–∞','–∞–ø—Ä–µ–ª—è','–º–∞—è','–∏—é–Ω—è','–∏—é–ª—è','–∞–≤–≥—É—Å—Ç–∞','—Å–µ–Ω—Ç—è–±—Ä—è','–æ–∫—Ç—è–±—Ä—è','–Ω–æ—è–±—Ä—è','–¥–µ–∫–∞–±—Ä—è'] %}
                                        {{ month_names[concert.datetime.month-1] }},
                                        {{ concert.datetime.strftime('%H:%M') }}
                                    </span>
                                {% endif %}
                            </span>
                        </div>
                    </td>
                    <td><span class="hall-badge">{{ item.hall.name if item.hall else '‚Äî' }}</span></td>
                    <td>
                        {% set seats = item.seats or 0 %}
                        {% set left = item.tickets_left or 0 %}
                        {% set percent_left = (left / seats * 100) if seats > 0 else 0 %}
                        {% if percent_left <= 10 %}
                            {% set bar_color = '#e53935' %} {# –∫—Ä–∞—Å–Ω—ã–π #}
                        {% elif percent_left <= 20 %}
                            {% set bar_color = '#ffb300' %} {# –∂—ë–ª—Ç—ã–π #}
                        {% else %}
                            {% set bar_color = '#43a047' %} {# –∑–µ–ª—ë–Ω—ã–π #}
                        {% endif %}
                        <span class="fill-bar" data-tooltip="–û—Å—Ç–∞–ª–æ—Å—å {{ left }} –∏–∑ {{ seats }} –º–µ—Å—Ç ({{ percent_left|round(1) }}%)">
                            <span class="fill-percent" style="color: {{ bar_color }}; font-weight:700;">
                                {{ percent_left|round(1) }}%
                                <span style="color:#8ca0c7; font-size:0.85em; font-weight:400; margin-left:6px;">({{ left }} –∏–∑ {{ seats }})</span>
                            </span>
                            <div class="fill-progress" style="background: none;">
                                <div class="fill-progress-inner"
                                     style="width: 100%; height: 100%; border-radius: 4px; background: linear-gradient(90deg, {{ bar_color }} 0%, {{ bar_color }} {{ percent_left|round(1) }}%, {{ bar_color }}80 {{ (percent_left + 7)|round(1) }}%, #e0e7ef {{ (percent_left + 15)|round(1) }}%, #e0e7ef 100%); transition: width 0.3s;">
                                </div>
                            </div>
                        </span>
                    </td>
                    <td>
                        {% if item.tickets_available %}
                            <span class="available-icon" title="–î–æ—Å—Ç—É–ø–Ω–æ">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="10" fill="#e6fbe8"/><path d="M6 10.5l3 3 5-6" stroke="#34c759" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </span>
                        {% else %}
                            <span class="unavailable-icon" title="–ù–µ—Ç –≤ –ø—Ä–æ–¥–∞–∂–µ">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="10" fill="#ffeaea"/><path d="M7 7l6 6M13 7l-6 6" stroke="#ff3b30" stroke-width="2" stroke-linecap="round"/></svg>
                            </span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á—ë—Ç—á–∏–∫–∞ –≤–∏–¥–∏–º—ã—Ö –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤
    function updateConcertsCount() {
        const table = document.getElementById('concerts-table');
        const countSpan = document.getElementById('concerts-count-value');
        if (!table || !countSpan) return;
        let visible = 0;
        Array.from(table.tBodies[0].rows).forEach(row => {
            if (row.style.display !== 'none') visible++;
        });
        countSpan.textContent = visible;
    }
    // JS-—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∏
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('concerts-table');
        const headers = table.querySelectorAll('th.sortable');
        let sortCol = null;
        let sortDir = 1;

        headers.forEach((th, idx) => {
            th.addEventListener('click', function() {
                if (sortCol === idx) {
                    sortDir = -sortDir;
                } else {
                    sortCol = idx;
                    sortDir = 1;
                }
                headers.forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
                th.classList.add(sortDir === 1 ? 'sorted-asc' : 'sorted-desc');
                sortTable(idx, sortDir);
                updateConcertsCount();
            });
        });
        
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ –Ω–æ–º–µ—Ä—É –∫–æ–Ω—Ü–µ—Ä—Ç–∞ (–∫–æ–ª–æ–Ω–∫–∞ 0) –≤ –≤–æ–∑—Ä–∞—Å—Ç–∞—é—â–µ–º –ø–æ—Ä—è–¥–∫–µ
        sortCol = 0;
        sortDir = 1;
        headers[0].classList.add('sorted-asc');
        sortTable(0, 1);
        updateConcertsCount();
        function parseCell(cell, idx) {
            let text = cell.textContent.trim();
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –Ω–æ–º–µ—Ä—É –∫–æ–Ω—Ü–µ—Ä—Ç–∞ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–π –∫–æ–ª–æ–Ω–∫–∏ (–∏–Ω–¥–µ–∫—Å 0)
            if (idx === 0) {
                let numEl = cell.querySelector && cell.querySelector('.concert-number');
                if (numEl) {
                    return parseInt(numEl.textContent.trim()) || 0;
                }
            }
            if (idx === 1) {
                // –ó–∞–ª: –Ω–∞–∑–≤–∞–Ω–∏–µ
                return text.toLowerCase();
            }
            if (idx === 2) {
                // –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: –ø—Ä–æ—Ü–µ–Ω—Ç
                let percent = text.replace(/[^\d]/g, '');
                return parseInt(percent) || 0;
            }
            if (idx === 3) {
                // –î–æ—Å—Ç—É–ø–Ω–æ: –∏–∫–æ–Ω–∫–∞ (available-icon = 1, unavailable-icon = 0)
                return cell.querySelector('.available-icon') !== null ? 1 : 0;
            }
            return text.toLowerCase();
        }
        function sortTable(col, dir) {
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.rows);
            rows.sort((a, b) => {
                let A = parseCell(a.cells[col], col);
                let B = parseCell(b.cells[col], col);
                if (A < B) return -1 * dir;
                if (A > B) return 1 * dir;
                return 0;
            });
            rows.forEach(row => tbody.appendChild(row));
        }
    });
    // –§–∏–ª—å—Ç—Ä –ø–æ –¥–Ω—è–º –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('concerts-table');
        const dayLinks = document.querySelectorAll('.day-filter-link');
        const resetBtn = document.getElementById('reset-day-filter');
        const filterAvailable = document.getElementById('filter-available');
        const filterUnavailable = document.getElementById('filter-unavailable');
        let activeDay = null;
        let availabilityFilter = null; // null, 'available', 'unavailable'

        function applyFilters() {
            Array.from(table.tBodies[0].rows).forEach(row => {
                // –§–∏–ª—å—Ç—Ä –ø–æ –¥–Ω—é
                let dateText = row.querySelector('.concert-date-text');
                let showByDay = true;
                if (activeDay && dateText) {
                    let rowDay = dateText.getAttribute('data-day');
                    showByDay = (rowDay === activeDay);
                }
                // –§–∏–ª—å—Ç—Ä –ø–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
                let cell = row.cells[3]; // –∫–æ–ª–æ–Ω–∫–∞ "–î–æ—Å—Ç—É–ø–Ω–æ" (–ø–æ—Å–ª–µ colspan=2)
                let isAvailable = cell && cell.querySelector('.available-icon') !== null;
                let showByAvailability = true;
                if (availabilityFilter === 'available') showByAvailability = isAvailable;
                if (availabilityFilter === 'unavailable') showByAvailability = !isAvailable;
                // –ò—Ç–æ–≥
                row.style.display = (showByDay && showByAvailability) ? '' : 'none';
            });
            updateConcertsCount();
        }

        dayLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                dayLinks.forEach(l => l.style.background = '#e0e7ff');
                dayLinks.forEach(l => l.style.color = '#4f5bd5');
                this.style.background = '#4f5bd5';
                this.style.color = '#fff';
                activeDay = this.getAttribute('data-day');
                applyFilters();
            });
        });
        resetBtn.addEventListener('click', function() {
            dayLinks.forEach(l => l.style.background = '#e0e7ff');
            dayLinks.forEach(l => l.style.color = '#4f5bd5');
            activeDay = null;
            // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
            availabilityFilter = null;
            filterAvailable.style.background = '';
            filterUnavailable.style.background = '';
            applyFilters();
        });
        filterAvailable.addEventListener('click', function() {
            if (availabilityFilter === 'available') {
                availabilityFilter = null;
                filterAvailable.style.background = '';
                filterUnavailable.style.background = '';
            } else {
                availabilityFilter = 'available';
                filterAvailable.style.background = '#e0e7ff';
                filterUnavailable.style.background = '';
            }
            applyFilters();
        });
        filterUnavailable.addEventListener('click', function() {
            if (availabilityFilter === 'unavailable') {
                availabilityFilter = null;
                filterAvailable.style.background = '';
                filterUnavailable.style.background = '';
            } else {
                availabilityFilter = 'unavailable';
                filterAvailable.style.background = '';
                filterUnavailable.style.background = '#e0e7ff';
            }
            applyFilters();
        });
        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        applyFilters();
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤
    document.addEventListener('DOMContentLoaded', function() {
        const refreshBtn = document.getElementById('refresh-tickets-btn');
        const refreshStatus = document.getElementById('refresh-status');
        
        if (refreshBtn) {
            refreshBtn.addEventListener('click', async function() {
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                refreshBtn.disabled = true;
                refreshBtn.style.background = '#bfc6e0';
                refreshBtn.textContent = 'üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
                refreshStatus.textContent = '–ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö...';
                
                try {
                    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö ID –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                    const table = document.getElementById('concerts-table');
                    const rows = Array.from(table.tBodies[0].rows);
                    const concertIds = [];
                    
                    rows.forEach(row => {
                        const concertNumber = row.querySelector('.concert-number');
                        if (concertNumber) {
                            const id = parseInt(concertNumber.textContent.trim());
                            if (!isNaN(id)) {
                                concertIds.push(id);
                            }
                        }
                    });
                    
                    if (concertIds.length === 0) {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤');
                    }
                    
                    refreshStatus.textContent = `–ó–∞–ø—Ä–æ—Å –¥–ª—è ${concertIds.length} –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤...`;
                    
                    // –í—ã–∑—ã–≤–∞–µ–º API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–∏–ª–µ—Ç–∞—Ö
                    const response = await fetch(`/api/tickets/availability?concert_ids=${concertIds.join(',')}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
                    }
                    
                    refreshStatus.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ ${Object.keys(data.data).length} –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤`;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ
                    updateConcertsTable(data.data);
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–µ—Ä–≤–∏—Å–∞
                    try {
                        const statsResponse = await fetch('/api/tickets/stats');
                        if (statsResponse.ok) {
                            const statsData = await statsResponse.json();
                            if (statsData.success && statsData.cache_stats) {
                                const requestCount = statsData.cache_stats.request_counter || 0;
                                refreshStatus.textContent = `‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${Object.keys(data.data).length} –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤ (–∑–∞–ø—Ä–æ—Å #${requestCount})`;
                            } else {
                                refreshStatus.textContent = `‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${Object.keys(data.data).length} –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤`;
                            }
                        } else {
                            refreshStatus.textContent = `‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${Object.keys(data.data).length} –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤`;
                        }
                    } catch (statsError) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:', statsError);
                        refreshStatus.textContent = `‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${Object.keys(data.data).length} –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤`;
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                    setTimeout(() => {
                        refreshStatus.textContent = '';
                    }, 3000);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∏–ª–µ—Ç–æ–≤:', error);
                    refreshStatus.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        refreshStatus.textContent = '';
                    }, 3000);
                } finally {
                    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                    refreshBtn.disabled = false;
                    refreshBtn.style.background = '#4f5bd5';
                    refreshBtn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –±–∏–ª–µ—Ç—ã';
                }
            });
        }
        
        function updateConcertsTable(ticketsData) {
            const table = document.getElementById('concerts-table');
            const rows = Array.from(table.tBodies[0].rows);
            
            rows.forEach(row => {
                const concertNumber = row.querySelector('.concert-number');
                if (concertNumber) {
                    const concertId = parseInt(concertNumber.textContent.trim());
                    const ticketInfo = ticketsData[concertId];
                    
                    if (ticketInfo) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
                        const availabilityCell = row.cells[2]; // –∫–æ–ª–æ–Ω–∫–∞ "–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å"
                        if (availabilityCell) {
                            const ticketsLeft = ticketInfo.tickets_left;
                            const totalSeats = ticketInfo.total_seats;
                            const percentLeft = totalSeats > 0 ? (ticketsLeft / totalSeats * 100) : 0;
                            
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç
                            let barColor;
                            if (percentLeft <= 10) {
                                barColor = '#e53935'; // –∫—Ä–∞—Å–Ω—ã–π
                            } else if (percentLeft <= 20) {
                                barColor = '#ffb300'; // –∂—ë–ª—Ç—ã–π
                            } else {
                                barColor = '#43a047'; // –∑–µ–ª—ë–Ω—ã–π
                            }
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —è—á–µ–π–∫–∏
                            availabilityCell.innerHTML = `
                                <span class="fill-bar" data-tooltip="–û—Å—Ç–∞–ª–æ—Å—å ${ticketsLeft} –∏–∑ ${totalSeats} –º–µ—Å—Ç (${percentLeft.toFixed(1)}%)">
                                    <span class="fill-percent" style="color: ${barColor}; font-weight:700;">
                                        ${percentLeft.toFixed(1)}%
                                        <span style="color:#8ca0c7; font-size:0.85em; font-weight:400; margin-left:6px;">(${ticketsLeft} –∏–∑ ${totalSeats})</span>
                                    </span>
                                    <div class="fill-progress" style="background: none;">
                                        <div class="fill-progress-inner"
                                             style="width: 100%; height: 100%; border-radius: 4px; background: linear-gradient(90deg, ${barColor} 0%, ${barColor} ${percentLeft.toFixed(1)}%, ${barColor}80 ${(percentLeft + 7).toFixed(1)}%, #e0e7ef ${(percentLeft + 15).toFixed(1)}%, #e0e7ef 100%); transition: width 0.3s;">
                                        </div>
                                    </div>
                                </span>
                            `;
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ (–∏–∫–æ–Ω–∫–∞)
                        const availableCell = row.cells[3]; // –∫–æ–ª–æ–Ω–∫–∞ "–î–æ—Å—Ç—É–ø–Ω–æ"
                        if (availableCell) {
                            if (ticketInfo.available) {
                                availableCell.innerHTML = `
                                    <span class="available-icon" title="–î–æ—Å—Ç—É–ø–Ω–æ">
                                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="10" fill="#e6fbe8"/><path d="M6 10.5l3 3 5-6" stroke="#34c759" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                    </span>
                                `;
                            } else {
                                availableCell.innerHTML = `
                                    <span class="unavailable-icon" title="–ù–µ—Ç –≤ –ø—Ä–æ–¥–∞–∂–µ">
                                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="10" fill="#ffeaea"/><path d="M7 7l6 6M13 7l-6 6" stroke="#ff3b30" stroke-width="2" stroke-linecap="round"/></svg>
                                    </span>
                                `;
                            }
                        }
                    }
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫–∏
            updateConcertsCount();
            updateAvailabilityCounters();
        }
        
        function updateAvailabilityCounters() {
            const table = document.getElementById('concerts-table');
            const rows = Array.from(table.tBodies[0].rows);
            let availableCount = 0;
            let unavailableCount = 0;
            
            rows.forEach(row => {
                const availableCell = row.cells[3]; // –∫–æ–ª–æ–Ω–∫–∞ "–î–æ—Å—Ç—É–ø–Ω–æ"
                if (availableCell && availableCell.querySelector('.available-icon')) {
                    availableCount++;
                } else if (availableCell && availableCell.querySelector('.unavailable-icon')) {
                    unavailableCount++;
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–æ–≤
            const filterAvailable = document.getElementById('filter-available');
            const filterUnavailable = document.getElementById('filter-unavailable');
            
            if (filterAvailable) {
                const availableSpan = filterAvailable.querySelector('span');
                if (availableSpan) {
                    availableSpan.textContent = availableCount;
                }
            }
            
            if (filterUnavailable) {
                const unavailableSpan = filterUnavailable.querySelector('span');
                if (unavailableSpan) {
                    unavailableSpan.textContent = unavailableCount;
                }
            }
        }
    });
    
    // –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –¥–ª—è –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è
    document.addEventListener('DOMContentLoaded', function() {
        const nav = document.getElementById('adminNav');
        const dropdown = document.getElementById('adminMenuDropdown');
        const dropdownBtn = document.getElementById('dropdownBtn');
        const dropdownContent = document.getElementById('dropdownContent');
        function updateDropdown() {
            dropdownContent.innerHTML = '<div class="admin-menu-dropdown-arrow">\n<svg width="24" height="12"><polygon points="12,12 0,0 24,0" fill="#f0f4ff"/></svg>\n</div>';
            let linksWrapper = document.createElement('div');
            linksWrapper.className = 'admin-menu-dropdown-links';
            let navWidth = nav.offsetWidth;
            let overflowed = [];
            const children = Array.from(nav.children).filter(el => el.classList.contains('admin-menu-btn'));
            children.forEach(el => { el.style.display = ''; });
            children.forEach(el => {
                const rect = el.getBoundingClientRect();
                const navRect = nav.getBoundingClientRect();
                if (rect.right > navRect.right - 120) { overflowed.push(el); }
            });
            if (overflowed.length > 0) {
                overflowed.forEach(el => {
                    let clone = el.cloneNode(true);
                    clone.classList.remove('admin-menu-btn');
                    if (clone.getAttribute('href') === '/') {
                        clone.innerHTML = '<span style="font-size:1.1em; margin-right:6px;">üåê</span>–ù–∞ —Å–∞–π—Ç';
                    } else {
                        clone.innerHTML = clone.textContent.trim();
                    }
                    linksWrapper.appendChild(clone);
                    el.style.display = 'none';
                });
                dropdownContent.appendChild(linksWrapper);
                dropdown.style.display = 'inline-block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        window.addEventListener('resize', updateDropdown);
        updateDropdown();
        dropdownBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdown.classList.toggle('open');
            if (dropdown.classList.contains('open')) {
                const btnRect = dropdownBtn.getBoundingClientRect();
                dropdownContent.style.left = btnRect.left + 'px';
                dropdownContent.style.top = (btnRect.bottom + 6) + 'px';
            }
        });
        document.body.addEventListener('click', function() {
            dropdown.classList.remove('open');
        });
    });
    </script>
</body>
</html> 