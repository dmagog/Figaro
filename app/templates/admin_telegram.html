<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞—Å—Å—ã–ª–∫–∞ Telegram ‚Äî –ê–¥–º–∏–Ω–∫–∞ –§–∏–≥–∞—Ä–æ</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        body { background: #f6f7fb; font-family: 'Segoe UI', 'Arial', sans-serif; margin: 0; }
        .admin-container { max-width: 1400px; margin: 40px auto; padding: 30px; background: white; border-radius: 18px; box-shadow: 0 8px 32px rgba(60,60,120,0.08); }
        .admin-header { margin-bottom: 30px; }
        .admin-nav-flex { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; position: relative; overflow-x: auto; padding-bottom: 4px; }
        .admin-menu-btn { background: #e0e7ff; color: #4f5bd5; padding: 10px 22px; border-radius: 10px; text-decoration: none; font-weight: 500; font-size: 1.08em; border: none; transition: background 0.18s, color 0.18s; display: inline-block; text-align: center; cursor: pointer; white-space: nowrap; }
        .admin-menu-btn:hover, .admin-menu-btn.active { background: #667eea; color: #fff; }
        
        .tg-dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .tg-stats-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; text-align: center; }
        .tg-stats-card h3 { margin: 0 0 8px 0; font-size: 1em; opacity: 0.9; }
        .tg-stats-card .number { font-size: 2em; font-weight: bold; margin-bottom: 3px; }
        .tg-stats-card .label { font-size: 0.8em; opacity: 0.8; }
        
        .tg-main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .tg-form-section { background: #f8f9fa; border-radius: 15px; padding: 25px; }
        .tg-form-section h3 { margin: 0 0 20px 0; color: #333; font-size: 1.3em; }
        
        .tg-form-group { margin-bottom: 20px; }
        .tg-form-group label { display: block; font-weight: 500; color: #4f5bd5; margin-bottom: 8px; font-size: 1.05em; }
        .tg-form-group input, .tg-form-group select, .tg-form-group textarea { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 1em; transition: border-color 0.2s; }
        .tg-form-group input:focus, .tg-form-group select:focus, .tg-form-group textarea:focus { border-color: #667eea; outline: none; }
        
        .tg-categories { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .tg-category-card { background: white; border: 2px solid #e1e5e9; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.2s; }
        .tg-category-card:hover { border-color: #667eea; transform: translateY(-2px); }
        .tg-category-card.selected { border-color: #667eea; background: #f0f4ff; }
        .tg-category-card h4 { margin: 0 0 8px 0; color: #333; font-size: 1.1em; }
        .tg-category-card .count { color: #667eea; font-weight: bold; font-size: 1.2em; }
        .tg-category-card .desc { color: #666; font-size: 0.9em; margin-top: 5px; }
        
        .tg-users-grid { max-height: 300px; overflow-y: auto; border: 2px solid #e1e5e9; border-radius: 8px; padding: 15px; background: white; }
        .tg-user-item { display: flex; align-items: center; padding: 8px; border-radius: 6px; margin-bottom: 5px; transition: background 0.2s; }
        .tg-user-item:hover { background: #f8f9fa; }
        .tg-user-item input[type="checkbox"] { margin-right: 12px; transform: scale(1.2); }
        .tg-user-info { flex: 1; }
        .tg-user-name { font-weight: 500; color: #333; }
        .tg-user-details { font-size: 0.85em; color: #666; margin-top: 2px; }
        
        .tg-template-selector { margin-bottom: 20px; }
        .tg-template-preview { background: white; border: 1px solid #e1e5e9; border-radius: 8px; padding: 15px; margin-top: 10px; font-size: 0.9em; color: #666; }
        
        .tg-send-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; width: 100%; transition: transform 0.2s; }
        .tg-send-btn:hover { transform: translateY(-2px); }
        .tg-send-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .tg-status { margin-top: 15px; padding: 12px; border-radius: 8px; font-weight: 500; text-align: center; opacity: 0; transition: opacity 0.3s; }
        .tg-status.visible { opacity: 1; }
        .tg-status.success { background: #d1fae5; color: #065f46; }
        .tg-status.error { background: #fee2e2; color: #991b1b; }
        
        .tg-campaigns { margin-top: 30px; }
        .tg-campaign-item { background: white; border: 1px solid #e1e5e9; border-radius: 10px; padding: 20px; margin-bottom: 15px; }
        .tg-campaign-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .tg-campaign-name { font-weight: 600; color: #333; font-size: 1.1em; }
        .tg-campaign-date { color: #666; font-size: 0.9em; }
        .tg-campaign-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .tg-stat-item { text-align: center; }
        .tg-stat-number { font-size: 1.5em; font-weight: bold; color: #667eea; }
        .tg-stat-label { font-size: 0.8em; color: #666; margin-top: 5px; }
        
        .tg-search-box { margin-bottom: 15px; }
        .tg-search-box input { width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 1em; }
        
        @media (max-width: 1200px) { .tg-main-content { grid-template-columns: 1fr; } }
        @media (max-width: 900px) { .tg-dashboard { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .tg-dashboard { grid-template-columns: 1fr; } .admin-container { padding: 15px; } }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header" style="display: flex; align-items: center; justify-content: space-between; gap: 24px;">
            <h1 style="font-size:2.2em; margin:0; flex-shrink:0;">–ê–¥–º–∏–Ω–∫–∞ —Ñ–µ—Å—Ç–∏–≤–∞–ª—è</h1>
            <nav class="admin-nav-flex" id="adminNav" style="flex:1;">
                <a href="/admin" class="admin-menu-btn">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="/admin/users" class="admin-menu-btn">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
                <a href="/admin/customers" class="admin-menu-btn">–ü–æ–∫—É–ø–∞—Ç–µ–ª–∏</a>
                <a href="/admin/purchases" class="admin-menu-btn">–ü–æ–∫—É–ø–∫–∏</a>
                <a href="/admin/concerts" class="admin-menu-btn">–ö–æ–Ω—Ü–µ—Ä—Ç—ã</a>
                <a href="/admin/halls" class="admin-menu-btn">–ó–∞–ª—ã</a>
                <a href="/admin/routes" class="admin-menu-btn">–ú–∞—Ä—à—Ä—É—Ç—ã</a>
                <a href="/admin/offprogram" class="admin-menu-btn">–û—Ñ—Ñ-–ø—Ä–æ–≥—Ä–∞–º–º–∞</a>
                <a href="/admin/artists" class="admin-menu-btn">–ê—Ä—Ç–∏—Å—Ç—ã</a>
                <a href="/admin/authors" class="admin-menu-btn">–ê–≤—Ç–æ—Ä—ã</a>
                <a href="/admin/compositions" class="admin-menu-btn">–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è</a>
                <a href="/admin/genres" class="admin-menu-btn">–ñ–∞–Ω—Ä—ã</a>
                <a href="/admin/telegram" class="admin-menu-btn active">–†–∞—Å—Å—ã–ª–∫–∞ Telegram</a>
                <a href="/" class="admin-menu-btn"><span style="font-size:1.1em; margin-right:6px;">üåê</span>–ù–∞ —Å–∞–π—Ç</a>
            </nav>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="tg-dashboard">
            <div class="tg-stats-card">
                <h3>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                <div class="number">{{ total_users }}</div>
                <div class="label">—Å Telegram</div>
            </div>
            <div class="tg-stats-card">
                <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏</h3>
                <div class="number">{{ users_with_purchases }}</div>
                <div class="label">—Å –ø–æ–∫—É–ø–∫–∞–º–∏</div>
            </div>
            <div class="tg-stats-card">
                <h3>–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                <div class="number">{{ new_users }}</div>
                <div class="label">–∑–∞ 30 –¥–Ω–µ–π</div>
            </div>
            <div class="tg-stats-card">
                <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                <div class="number">{{ active_users }}</div>
                <div class="label">–∑–∞ 90 –¥–Ω–µ–π</div>
            </div>
        </div>

        <div class="tg-main-content">
            <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
            <div class="tg-form-section">
                <h3>üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
                <form id="tg-send-form">
                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                    <div class="tg-form-group">
                        <label>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</label>
                        <div class="tg-categories">
                            <div class="tg-category-card" data-category="all">
                                <h4>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h4>
                                <div class="count">{{ total_users }}</div>
                                <div class="desc">–í—Å–µ —Å Telegram</div>
                            </div>
                            <div class="tg-category-card" data-category="with_purchases">
                                <h4>–° –ø–æ–∫—É–ø–∫–∞–º–∏</h4>
                                <div class="count">{{ users_with_purchases }}</div>
                                <div class="desc">–ü–æ–∫—É–ø–∞–ª–∏ –±–∏–ª–µ—Ç—ã</div>
                            </div>
                            <div class="tg-category-card" data-category="without_purchases">
                                <h4>–ë–µ–∑ –ø–æ–∫—É–ø–æ–∫</h4>
                                <div class="count">{{ users_without_purchases }}</div>
                                <div class="desc">–ï—â–µ –Ω–µ –ø–æ–∫—É–ø–∞–ª–∏</div>
                            </div>
                            <div class="tg-category-card" data-category="new_users">
                                <h4>–ù–æ–≤—ã–µ</h4>
                                <div class="count">{{ new_users }}</div>
                                <div class="desc">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –Ω–µ–¥–∞–≤–Ω–æ</div>
                            </div>
                            <div class="tg-category-card" data-category="active_users">
                                <h4>–ê–∫—Ç–∏–≤–Ω—ã–µ</h4>
                                <div class="count">{{ active_users }}</div>
                                <div class="desc">–ü–æ–∫—É–ø–∞–ª–∏ –Ω–µ–¥–∞–≤–Ω–æ</div>
                            </div>
                        </div>
                    </div>

                    <!-- –®–∞–±–ª–æ–Ω—ã -->
                    <div class="tg-form-group">
                        <label for="template-select">–®–∞–±–ª–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è:</label>
                        <select id="template-select" class="tg-template-selector">
                            <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω ‚Äî</option>
                            {% for template in templates %}
                                <option value="{{ template.id }}" data-content="{{ template.content }}">{{ template.name }}</option>
                            {% endfor %}
                        </select>
                        <div id="template-preview" class="tg-template-preview" style="display: none;"></div>
                    </div>

                    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ -->
                    <div class="tg-form-group">
                        <label for="message-text">–°–æ–æ–±—â–µ–Ω–∏–µ:</label>
                        <textarea id="message-text" name="message" rows="6" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω..."></textarea>
                        <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: {name}, {email}, {tickets_count}, {total_spent}, {concerts_count}
                        </div>
                    </div>

                    <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏ -->
                    <div class="tg-form-group">
                        <label for="campaign-name">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏:</label>
                        <input type="text" id="campaign-name" name="campaign_name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                    </div>

                    <!-- –§–∞–π–ª -->
                    <div class="tg-form-group">
                        <label for="file-upload">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª:</label>
                        <input type="file" id="file-upload" name="file" accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar">
                    </div>

                    <!-- Markdown -->
                    <div class="tg-form-group" style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="use-markdown" name="markdown" checked style="width: 18px; height: 18px;">
                        <label for="use-markdown" style="margin: 0;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Markdown</label>
                    </div>

                    <button type="submit" class="tg-send-btn">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é</button>
                    <div id="send-status" class="tg-status"></div>
                </form>
            </div>

            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏ -->
            <div class="tg-form-section">
                <h3>üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏</h3>
                <div id="campaigns-list">
                    {% for campaign in recent_campaigns %}
                        <div class="tg-campaign-item">
                            <div class="tg-campaign-header">
                                <div class="tg-campaign-name">{{ campaign.name }}</div>
                                <div class="tg-campaign-date">{{ campaign.created_at.strftime('%d.%m.%Y %H:%M') if campaign.created_at else '' }}</div>
                            </div>
                            <div class="tg-campaign-stats">
                                <div class="tg-stat-item">
                                    <div class="tg-stat-number" style="color: #333; font-weight: bold; font-size: 1.8em;">{{ campaign.target_users_count or 0 }}</div>
                                    <div class="tg-stat-label">–¶–µ–ª–µ–≤—ã—Ö</div>
                                </div>
                                <div class="tg-stat-item">
                                    <div class="tg-stat-number" style="color: #333; font-weight: bold; font-size: 1.8em;">{{ campaign.sent_count or 0 }}</div>
                                    <div class="tg-stat-label">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
                                </div>
                                <div class="tg-stat-item">
                                    <div class="tg-stat-number" style="color: #333; font-weight: bold; font-size: 1.8em;">{{ campaign.delivered_count or 0 }}</div>
                                    <div class="tg-stat-label">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</div>
                                </div>
                                <div class="tg-stat-item">
                                    <div class="tg-stat-number" style="color: #333; font-weight: bold; font-size: 1.8em;">{{ campaign.failed_count or 0 }}</div>
                                    <div class="tg-stat-label">–û—à–∏–±–æ–∫</div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <p style="color: #666; text-align: center; padding: 20px;">–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞–º–ø–∞–Ω–∏–π</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <script>
        // –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        document.querySelectorAll('.tg-category-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.tg-category-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
            });
        });

        // –®–∞–±–ª–æ–Ω—ã
        document.getElementById('template-select').addEventListener('change', function() {
            const preview = document.getElementById('template-preview');
            const messageText = document.getElementById('message-text');
            
            if (this.value) {
                const selectedOption = this.options[this.selectedIndex];
                const content = selectedOption.getAttribute('data-content');
                preview.textContent = content;
                preview.style.display = 'block';
                messageText.value = content;
            } else {
                preview.style.display = 'none';
            }
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
        document.getElementById('tg-send-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const selectedCategory = document.querySelector('.tg-category-card.selected');
            if (!selectedCategory) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
                return;
            }
            
            const messageText = document.getElementById('message-text').value.trim();
            if (!messageText) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }
            
            const formData = new FormData();
            formData.append('category', selectedCategory.dataset.category);
            formData.append('message', messageText);
            formData.append('campaign_name', document.getElementById('campaign-name').value);
            formData.append('markdown', document.getElementById('use-markdown').checked ? '1' : '0');
            
            const fileInput = document.getElementById('file-upload');
            if (fileInput.files[0]) {
                formData.append('file', fileInput.files[0]);
            }
            
            const templateSelect = document.getElementById('template-select');
            if (templateSelect.value) {
                formData.append('template_id', templateSelect.value);
            }
            
            const sendBtn = document.querySelector('.tg-send-btn');
            const status = document.getElementById('send-status');
            
            sendBtn.disabled = true;
            sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
            status.textContent = '–ó–∞–ø—É—Å–∫ –∫–∞–º–ø–∞–Ω–∏–∏...';
            status.className = 'tg-status visible';
            
            try {
                const response = await fetch('/admin/send-telegram', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    status.textContent = `‚úÖ ${data.message}`;
                    status.className = 'tg-status visible success';
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('message-text').value = '';
                    document.getElementById('campaign-name').value = '';
                    document.getElementById('file-upload').value = '';
                    document.getElementById('template-select').value = '';
                    document.getElementById('template-preview').style.display = 'none';
                    document.querySelectorAll('.tg-category-card').forEach(c => c.classList.remove('selected'));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–ø–∞–Ω–∏–π —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    status.textContent = `‚ùå ${data.error}`;
                    status.className = 'tg-status visible error';
                }
            } catch (error) {
                status.textContent = '‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏';
                status.className = 'tg-status visible error';
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é';
            }
        });
    </script>
</body>
</html> 