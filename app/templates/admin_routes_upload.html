{% extends "admin_routes_main.html" %}
{% block routes_content %}
<style>
button[disabled] {
    background: #bfc6e0 !important;
    color: #fff !important;
    cursor: not-allowed !important;
    opacity: 0.7;
    box-shadow: none;
}
</style>
{% if available_routes_count is defined and available_routes_count is not none %}
<div style="max-width:600px; margin:0 auto 24px auto; background: #f8f9ff; border-radius:12px; padding:18px 24px; color:#4f5bd5; font-size:1em; box-shadow:0 2px 8px rgba(60,60,120,0.04); border-left:4px solid #4f5bd5;">
    <div style="font-weight:500; margin-bottom:8px;">–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤:</div>
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
        <div>
            –î–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤: <b style="color:#43A047;">{{ available_routes_count }}</b>
            {% if summary.routes_count and summary.routes_count > 0 %}
                <span style="color:#666; font-size:0.9em;">({{ "%.1f"|format(available_routes_count / summary.routes_count * 100) }}% –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞)</span>
            {% endif %}
        </div>
        {% if last_check_date %}
            <div style="font-size:0.9em; color:#666;">
                –û–±–Ω–æ–≤–ª–µ–Ω–æ: <b>{{ last_check_date.strftime('%d.%m.%Y %H:%M') }}</b>
            </div>
        {% endif %}
    </div>
    <div style="margin-top:12px; padding-top:12px; border-top:1px solid #e0e7ff;">
        <button id="update-routes-btn" style="padding:8px 16px; border-radius:6px; background:#4f5bd5; color:#fff; font-weight:500; border:none; cursor:pointer; font-size:0.9em;">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
        </button>
        <span id="routes-update-status" style="margin-left:12px; font-size:0.9em; color:#666;"></span>
    </div>
</div>
{% endif %}
<div style="max-width:600px; margin:0 auto 32px auto; background: #fff;; border-radius:12px; padding:22px 28px 18px 28px; color:#3a3a4a; font-size:1.08em; box-shadow:0 2px 8px rgba(60,60,120,0.04);">
    <b>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</b> –ù–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å –º–∞—Ä—à—Ä—É—Ç–∞–º–∏ —Ñ–µ—Å—Ç–∏–≤–∞–ª—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ <b>.csv</b>.<br>
    <ul style="margin:12px 0 0 18px;">
        <li>–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –≤—Å–µ—Ö –¥–Ω–µ–π —Ñ–µ—Å—Ç–∏–≤–∞–ª—è.</li>
        <li>–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—á–Ω—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö.</li>
        <li>–ü–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤.</li>
        <li>–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –æ—à–∏–±–∫–∏, –æ–Ω–∏ –æ—Ç–æ–±—Ä–∞–∑—è—Ç—Å—è –Ω–∏–∂–µ —Ñ–æ—Ä–º—ã.</li>
    </ul>
</div>
<form id="upload-form" enctype="multipart/form-data" style="margin-bottom:24px; max-width:420px; background:#fff; border-radius:16px; box-shadow:0 2px 12px rgba(60,60,120,0.06); padding:32px 32px 24px 32px; margin-left:auto; margin-right:auto;">
    <label for="routes-file" style="font-weight:500; display:block; margin-bottom:12px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª –º–∞—Ä—à—Ä—É—Ç–æ–≤ (.csv):</label>
    <input type="file" id="routes-file" name="file" accept=".csv" required style="margin-bottom:18px; width:100%;">
    <button type="submit" style="padding:10px 0; width:100%; border-radius:8px; background:#4f5bd5; color:#fff; font-weight:500; border:none; cursor:pointer; font-size:1.08em;">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
</form>
<div id="progress" style="display:none; margin-bottom:18px; color:#4f5bd5; text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
<div id="result" style="margin-top:18px; text-align:center;"></div>
<script>
const form = document.getElementById('upload-form');
const fileInput = document.getElementById('routes-file');
const progress = document.getElementById('progress');
const result = document.getElementById('result');
const updateRoutesBtn = document.getElementById('update-routes-btn');
const routesUpdateStatus = document.getElementById('routes-update-status');
let pollInterval = null;

form.onsubmit = async function(e) {
    e.preventDefault();
    if (!fileInput.files.length) return;
    // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
    form.querySelector('button[type="submit"]').disabled = true;
    fileInput.disabled = true;
    progress.style.display = 'block';
    progress.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...';
    result.innerHTML = '';
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    try {
        const resp = await fetch('/admin/routes/upload', {
            method: 'POST',
            body: formData
        });
        const data = await resp.json();
        if (data.success) {
            progress.innerHTML = '–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–¥—ë—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤...';
            pollUploadStatus();
        } else {
            progress.style.display = 'none';
            result.innerHTML = `<span style='color:red;'>–û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</span>`;
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
            form.querySelector('button[type="submit"]').disabled = false;
            fileInput.disabled = false;
        }
    } catch (err) {
        progress.style.display = 'none';
        result.innerHTML = `<span style='color:red;'>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º</span>`;
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
        form.querySelector('button[type="submit"]').disabled = false;
        fileInput.disabled = false;
    }
};

function pollUploadStatus() {
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(async () => {
        try {
            const resp = await fetch('/admin/routes/upload_status');
            const status = await resp.json();
            if (status.error) {
                progress.style.display = 'none';
                result.innerHTML = `<span style='color:red;'>–û—à–∏–±–∫–∞: ${status.error}</span>`;
                clearInterval(pollInterval);
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
                form.querySelector('button[type="submit"]').disabled = false;
                fileInput.disabled = false;
                return;
            }
            if (status.in_progress) {
                let percent = status.total ? Math.round((status.progress / status.total) * 100) : 0;
                progress.style.display = 'block';
                progress.innerHTML = `–û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤: ${status.progress} / ${status.total} (${percent}%)`;
            } else {
                // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É AvailableRoute
                progress.style.display = 'block';
                progress.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–∞—Ä—à—Ä—É—Ç–æ–≤...';
                result.innerHTML = `<b>–ú–∞—Ä—à—Ä—É—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã!</b><br>–î–æ–±–∞–≤–ª–µ–Ω–æ: ${status.added}, –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${status.updated}`;
                clearInterval(pollInterval);
                
                // –ù–∞—á–∏–Ω–∞–µ–º –æ–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ AvailableRoute
                pollAvailableRoutesStatus();
            }
        } catch (err) {
            progress.style.display = 'none';
            result.innerHTML = `<span style='color:red;'>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º</span>`;
            clearInterval(pollInterval);
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
            form.querySelector('button[type="submit"]').disabled = false;
            fileInput.disabled = false;
        }
    }, 1000);
}

function pollAvailableRoutesStatus() {
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(async () => {
        try {
            const resp = await fetch('/admin/routes/available_routes_status');
            const status = await resp.json();
            if (status.error) {
                progress.style.display = 'none';
                result.innerHTML += `<br><span style='color:red;'>–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏: ${status.error}</span>`;
                clearInterval(pollInterval);
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
                form.querySelector('button[type="submit"]').disabled = false;
                fileInput.disabled = false;
                return;
            }
            if (status.in_progress) {
                let percent = status.total ? Math.round((status.progress / status.total) * 100) : 0;
                progress.style.display = 'block';
                progress.innerHTML = `–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤: ${status.progress} / ${status.total} (${percent}%) - –Ω–∞–π–¥–µ–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö: ${status.available_count || 0}`;
            } else {
                progress.style.display = 'none';
                result.innerHTML += `<br><b>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</b><br>–î–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤: ${status.available_count || 0} –∏–∑ ${status.total_routes || 0} (${status.availability_percentage || 0}%)`;
                clearInterval(pollInterval);
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                form.reset();
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
                form.querySelector('button[type="submit"]').disabled = false;
                fileInput.disabled = false;
                // –†–µ–¥–∏—Ä–µ–∫—Ç–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    window.location.href = '/admin/routes/view';
                }, 2000);
            }
        } catch (err) {
            progress.style.display = 'none';
            result.innerHTML += `<br><span style='color:red;'>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏</span>`;
            clearInterval(pollInterval);
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
            form.querySelector('button[type="submit"]').disabled = false;
            fileInput.disabled = false;
        }
    }, 1000);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
if (updateRoutesBtn) {
    updateRoutesBtn.addEventListener('click', async function() {
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        updateRoutesBtn.disabled = true;
        updateRoutesBtn.style.background = '#bfc6e0';
        updateRoutesBtn.textContent = 'üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
        routesUpdateStatus.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤...';
        
        try {
            const response = await fetch('/api/routes/update-availability', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤');
            }
            
            const result = data.result;
            routesUpdateStatus.textContent = `‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ: —É–¥–∞–ª–µ–Ω–æ ${result.deleted_count}, –¥–æ–±–∞–≤–ª–µ–Ω–æ ${result.added_count}, –≤—Å–µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ ${result.current_count}`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                routesUpdateStatus.textContent = '';
            }, 5000);
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            setTimeout(() => {
                window.location.reload();
            }, 5000);
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤:', error);
            routesUpdateStatus.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                routesUpdateStatus.textContent = '';
            }, 5000);
        } finally {
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            updateRoutesBtn.disabled = false;
            updateRoutesBtn.style.background = '#4f5bd5';
            updateRoutesBtn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã';
        }
    });
}
</script>
{% endblock %} 