{% extends "admin_routes_main.html" %}
{% block routes_content %}

<style>
.routes-header {
    margin-bottom: 12px;
}

.routes-header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.routes-title {
    font-size: 1.2em;
    color: #4f5bd5;
    margin-bottom: 6px;
    font-weight: 600;
}

.routes-description {
    color: #787878;
    margin: 0;
    font-size: 0.5em;
    line-height: 1.3;
}



.routes-table-container {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(60,60,120,0.04);
    overflow-x: auto;
    overflow-y: auto; /* –î–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
    margin-bottom: 16px;
    max-width: 100%;
    height: 600px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏ */
    position: relative;
}

.routes-table {
    width: 100%;
    min-width: 1400px;
    border-collapse: collapse;
    font-size: 0.9em;
}

.routes-table th {
    background: #f8f9ff;
    color: #4f5bd5;
    font-weight: 600;
    padding: 12px 16px;
    text-align: left;
    border-bottom: 2px solid #e0e7ff;
    font-size: 0.85em;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: background-color 0.2s;
    position: relative;
    white-space: nowrap;
}

.routes-table th:hover {
    background: #e8f0ff;
}

.routes-table th.sortable::after {
    content: '‚Üï';
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.8em;
    opacity: 0.5;
}

.routes-table th.sort-asc::after {
    content: '‚Üë';
    opacity: 1;
}

.routes-table th.sort-desc::after {
    content: '‚Üì';
    opacity: 1;
}

.routes-table td {
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    color: #3a3a4a;
}

.routes-table tr:hover {
    background: #f8f9ff;
}

.route-id {
    font-weight: 600;
    color: #4f5bd5;
    font-family: 'Courier New', monospace;
}

.route-composition {
    font-weight: 500;
    color: #43A047;
}

.route-time {
    font-family: 'Courier New', monospace;
    color: #666;
}

.route-costs {
    font-weight: 600;
    color: #e53935;
}

.route-score {
    font-weight: 500;
    color: #4f5bd5;
}

.route-level {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.8em;
    font-weight: 500;
    text-align: center;
}

.route-level-high {
    background: #e8f5e8;
    color: #43A047;
}

.route-level-medium {
    background: #fff3e0;
    color: #ff9800;
}

.route-level-low {
    background: #ffebee;
    color: #e53935;
}

.route-last-check {
    font-size: 0.8em;
    color: #999;
    font-style: italic;
}

.no-routes {
    text-align: center;
    padding: 40px;
    color: #666;
}

.no-routes-icon {
    font-size: 2em;
    margin-bottom: 16px;
    opacity: 0.5;
}

.pagination {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    margin-top: 16px;
}

.pagination-info {
    font-size: 0.9em;
    color: #666;
}

.pagination-controls {
    display: flex;
    gap: 8px;
    align-items: center;
}

.pagination-dots {
    padding: 8px 12px;
    color: #666;
}

.pagination-btn {
    padding: 8px 12px;
    border: 1px solid #e0e7ff;
    background: #fff;
    color: #4f5bd5;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9em;
}

.pagination-btn:hover {
    background: #f8f9ff;
}

.pagination-btn.active {
    background: #4f5bd5;
    color: #fff;
    border-color: #4f5bd5;
}

.pagination-btn:disabled {
    background: #f5f5f5;
    color: #ccc;
    cursor: not-allowed;
    border-color: #f0f0f0;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏ */
.virtual-table {
    height: 100%;
    overflow-y: auto;
    position: relative;
}

.virtual-table tbody {
    position: relative;
}

.virtual-row {
    position: absolute;
    width: 100%;
    left: 0;
}

.loading-indicator {
    display: none;
    text-align: center;
    padding: 20px;
    color: #666;
    font-size: 0.9em;
}

.loading-indicator.show {
    display: block;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #4f5bd5;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.scroll-sentinel {
    height: 20px;
    width: 100%;
}

/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å–∫—Ä–æ–ª–ª–∞ */
.routes-table-container {
    /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–æ–∂–µ—Ç —Å–∫—Ä–æ–ª–ª–∏—Ç—å—Å—è */
    overflow: auto !important;
}

.routes-table {
    /* –£–±–∏—Ä–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É —É —Ç–∞–±–ª–∏—Ü—ã, —á—Ç–æ–±—ã –æ–Ω–∞ –º–æ–≥–ª–∞ —Ä–∞—Å—Ç–∏ */
    height: auto;
    min-height: 100%;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã */
.routes-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #f8f9ff;
}

</style>

<div class="routes-header">
    <div class="routes-header-content">
        <div>
            <p class="routes-description">–¢–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö —Ñ–µ—Å—Ç–∏–≤–∞–ª—å–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤, –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –±–∏–ª–µ—Ç–æ–≤ –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤.</p>
        </div>
    </div>
</div>

{% if routes_count and routes_count > 0 %}
    {% if routes_data and routes_data|length > 0 %}
<div class="routes-table-container">
    <table class="routes-table virtual-table">
        <thead>
            <tr>
                <th class="sortable" data-sort="id">ID</th>
                <th class="sortable" data-sort="composition">–°–æ—Å—Ç–∞–≤</th>
                <th class="sortable" data-sort="days" title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π">üìÖ</th>
                <th class="sortable" data-sort="concerts" title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤">üéµ</th>
                <th class="sortable" data-sort="halls" title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ª–æ–≤">üèõÔ∏è</th>
                <th class="sortable" data-sort="genre" title="–ñ–∞–Ω—Ä">üé≠</th>
                <th class="sortable" data-sort="show_time" title="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Ü–µ—Ä—Ç–∞">‚è±Ô∏è</th>
                <th class="sortable" data-sort="trans_time" title="–í—Ä–µ–º—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤">üö∂</th>
                <th class="sortable" data-sort="wait_time" title="–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è">‚è≥</th>
                <th class="sortable" data-sort="costs" title="–°—Ç–æ–∏–º–æ—Å—Ç—å">üí∞</th>
                <th class="sortable" data-sort="comfort_score" title="–û—Ü–µ–Ω–∫–∞ –∫–æ–º—Ñ–æ—Ä—Ç–∞">üòå</th>
                <th class="sortable" data-sort="comfort_level" title="–£—Ä–æ–≤–µ–Ω—å –∫–æ–º—Ñ–æ—Ä—Ç–∞">–£—Ä–æ–≤–µ–Ω—å</th>
                <th class="sortable" data-sort="intellect_score" title="–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞">üß†</th>
                <th class="sortable" data-sort="intellect_category" title="–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
            </tr>
        </thead>
        <tbody id="virtual-tbody">
            <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </tbody>
    </table>
    <div class="loading-indicator" id="loading-indicator">
        <div class="loading-spinner"></div>
        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
    </div>
    <div class="scroll-sentinel" id="scroll-sentinel"></div>
</div>

<div class="pagination-info" style="text-align: center; margin-top: 16px; color: #666; font-size: 0.9em;">
    –ó–∞–≥—Ä—É–∂–µ–Ω–æ <span id="loaded-count">0</span> –∏–∑ <span id="total-count">0</span> –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
</div>

    {% else %}
    <div class="no-routes">
        <div class="no-routes-icon">üó∫Ô∏è</div>
        <div style="font-size: 1.2em; margin-bottom: 8px;">–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        <div style="color: #999; margin-bottom: 16px;">
            –í–æ–∑–º–æ–∂–Ω–æ, –≤—Å–µ –∫–æ–Ω—Ü–µ—Ä—Ç—ã –≤ –º–∞—Ä—à—Ä—É—Ç–∞—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –∏–ª–∏ –º–∞—Ä—à—Ä—É—Ç—ã –Ω–µ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.
        </div>
        <div style="font-size: 0.9em; color: #666;">
            <a href="/admin/routes/upload" style="color: #4f5bd5; text-decoration: none;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã</a> | 
            <a href="/admin/routes/concerts" style="color: #4f5bd5; text-decoration: none;">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤</a>
        </div>
    </div>
    {% endif %}
{% else %}
<div class="no-routes">
    <div class="no-routes-icon">üó∫Ô∏è</div>
    <div style="font-size: 1.2em; margin-bottom: 8px; color: #e53935;">–ú–∞—Ä—à—Ä—É—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>
    <div style="color: #999; margin-bottom: 16px;">
        –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å –º–∞—Ä—à—Ä—É—Ç–∞–º–∏.
    </div>
    <div style="font-size: 0.9em; color: #666;">
        <a href="/admin/routes/upload" style="color: #4f5bd5; text-decoration: none;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã</a>
    </div>
</div>
{% endif %}

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏
let loadedData = [];
let currentOffset = 0;
let isLoading = false;
let hasMoreData = true;
let currentSortBy = 'concerts';
let currentSortOrder = 'desc';
let totalCount = 0;
const BATCH_SIZE = 100; // –†–∞–∑–º–µ—Ä –ø–æ—Ä—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
let scrollObserver = null; // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞

// –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏
function initializeVirtualization() {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏...');
    
    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
    const table = document.querySelector('.routes-table');
    const tbody = document.getElementById('virtual-tbody');
    const loadingIndicator = document.getElementById('loading-indicator');
    const scrollSentinel = document.getElementById('scroll-sentinel');
    
    if (!table || !tbody) {
        console.error('–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!');
        return false;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    currentSortBy = urlParams.get('sort_by') || 'concerts';
    currentSortOrder = urlParams.get('sort_order') || 'desc';
    
    console.log('–¢–µ–∫—É—â–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:', { sortBy: currentSortBy, sortOrder: currentSortOrder });
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    updateSortIndicators(currentSortBy, currentSortOrder);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    const headers = table.querySelectorAll('th.sortable');
    headers.forEach(header => {
        const sortField = header.getAttribute('data-sort');
        header.addEventListener('click', function() {
            console.log('–ö–ª–∏–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É:', sortField);
            changeSort(sortField);
        });
    });
    
    // –°–æ–∑–¥–∞–µ–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å –¥–ª—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
    if (scrollObserver) {
        scrollObserver.disconnect(); // –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å
    }
    
    scrollObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && hasMoreData && !isLoading) {
                console.log('Scroll sentinel –≤–∏–¥–∏–º, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...');
                loadMoreData();
            }
        });
    });
    
    if (scrollSentinel) {
        scrollObserver.observe(scrollSentinel);
        console.log('–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å —Å–∫—Ä–æ–ª–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—É—é –ø–æ—Ä—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö
    loadMoreData();
    
    return true;
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è —Å–∫—Ä–æ–ª–ª–∞
function forceCheckScrollObserver() {
    console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è —Å–∫—Ä–æ–ª–ª–∞...');
    
    const scrollSentinel = document.getElementById('scroll-sentinel');
    console.log('Scroll sentinel –Ω–∞–π–¥–µ–Ω:', !!scrollSentinel);
    
    if (scrollObserver) {
        console.log('–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ...');
        // –û—Ç–∫–ª—é—á–∞–µ–º –∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å
        scrollObserver.disconnect();
        if (scrollSentinel) {
            scrollObserver.observe(scrollSentinel);
            console.log('–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω –∫ scroll sentinel');
        }
    } else {
        console.error('–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
    }
}

// –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è —Å–∫—Ä–æ–ª–ª–∞
function restoreScrollObserver() {
    const scrollSentinel = document.getElementById('scroll-sentinel');
    if (scrollSentinel && scrollObserver) {
        // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫–ª—é—á–∞–µ–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å –æ—Ç –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        scrollObserver.disconnect();
        // –ó–∞—Ç–µ–º –ø–æ–¥–∫–ª—é—á–∞–µ–º –∫ scroll sentinel
        scrollObserver.observe(scrollSentinel);
        console.log('–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å —Å–∫—Ä–æ–ª–ª–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞:', scrollSentinel);
    } else {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å —Å–∫—Ä–æ–ª–ª–∞:', {
            scrollSentinel: !!scrollSentinel,
            scrollObserver: !!scrollObserver
        });
        // –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
        forceCheckScrollObserver();
    }
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
async function loadMoreData() {
    if (isLoading || !hasMoreData) {
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞:', { isLoading, hasMoreData });
        return;
    }
    
    console.log('–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö...');
    isLoading = true;
    showLoadingIndicator();
    
    try {
        console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ: offset=${currentOffset}, limit=${BATCH_SIZE}, sort_by=${currentSortBy}, sort_order=${currentSortOrder}`);
        
        const response = await fetch(`/api/routes?offset=${currentOffset}&limit=${BATCH_SIZE}&sort_by=${currentSortBy}&sort_order=${currentSortOrder}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            loadedData.push(...result.data);
            appendRowsToTable(result.data);
            
            currentOffset += result.data.length;
            totalCount = result.total_count;
            hasMoreData = result.has_more;
            
            updateCounters();
            console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${result.data.length} —Å—Ç—Ä–æ–∫, –≤—Å–µ–≥–æ: ${loadedData.length}/${totalCount}, –µ—Å—Ç—å –µ—â–µ: ${hasMoreData}`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å —Å–∫—Ä–æ–ª–ª–∞
            if (hasMoreData) {
                restoreScrollObserver();
            }
        } else {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', result.error);
            throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        const tbody = document.getElementById('virtual-tbody');
        if (tbody && tbody.children.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="14" style="text-align: center; padding: 40px; color: #e53935;">
                        <div style="font-size: 1.2em; margin-bottom: 10px;">‚ùå</div>
                        <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>
                        <div style="font-size: 0.9em; margin-top: 8px;">${error.message}</div>
                        <button onclick="retryLoad()" style="margin-top: 16px; padding: 8px 16px; background: #4f5bd5; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                        </button>
                    </td>
                </tr>
            `;
        }
    } finally {
        isLoading = false;
        hideLoadingIndicator();
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
function retryLoad() {
    console.log('–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    loadedData = [];
    currentOffset = 0;
    hasMoreData = true;
    
    // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
    const tbody = document.getElementById('virtual-tbody');
    if (tbody) {
        tbody.innerHTML = '';
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å —Å–∫—Ä–æ–ª–ª–∞
    restoreScrollObserver();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–Ω–æ–≤–æ
    loadMoreData();
}

// –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü—É
function appendRowsToTable(data) {
    const tbody = document.getElementById('virtual-tbody');
    if (!tbody) return;
    
    data.forEach(route => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="route-id">${route.id}</td>
            <td class="route-composition" data-sort="${route.composition_count}">${route.composition}</td>
            <td data-sort="${route.days}">${route.days}</td>
            <td data-sort="${route.concerts}">${route.concerts}</td>
            <td data-sort="${route.halls}">${route.halls}</td>
            <td data-sort="${route.genre}">${route.genre}</td>
            <td class="route-time" data-sort="${route.show_time}">${route.show_time_display}</td>
            <td class="route-time" data-sort="${route.trans_time}">${route.trans_time_display}</td>
            <td class="route-time" data-sort="${route.wait_time}">${route.wait_time_display}</td>
            <td class="route-costs" data-sort="${route.costs}">${route.costs_display}</td>
            <td class="route-score" data-sort="${route.comfort_score}">${route.comfort_score_display}</td>
            <td data-sort="${route.comfort_level}">
                ${getComfortLevelHtml(route.comfort_level)}
            </td>
            <td class="route-score" data-sort="${route.intellect_score}">${route.intellect_score_display}</td>
            <td data-sort="${route.intellect_category}">${route.intellect_category}</td>
        `;
        tbody.appendChild(row);
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è HTML —É—Ä–æ–≤–Ω—è –∫–æ–º—Ñ–æ—Ä—Ç–∞
function getComfortLevelHtml(level) {
    if (level === 'High') {
        return '<span class="route-level route-level-high">–í—ã—Å–æ–∫–∏–π</span>';
    } else if (level === 'Medium') {
        return '<span class="route-level route-level-medium">–°—Ä–µ–¥–Ω–∏–π</span>';
    } else if (level === 'Low') {
        return '<span class="route-level route-level-low">–ù–∏–∑–∫–∏–π</span>';
    } else {
        return `<span class="route-level">${level}</span>`;
    }
}

// –§—É–Ω–∫—Ü–∏—è —Å–º–µ–Ω—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
function changeSort(sortField) {
    console.log('–°–º–µ–Ω–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –Ω–∞:', sortField);
    
    let newSortOrder = 'desc';
    if (currentSortBy === sortField) {
        newSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
    }
    
    console.log('–ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏:', { sortField, newSortOrder });
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    loadedData = [];
    currentOffset = 0;
    hasMoreData = true;
    currentSortBy = sortField;
    currentSortOrder = newSortOrder;
    
    // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
    const tbody = document.getElementById('virtual-tbody');
    if (tbody) {
        tbody.innerHTML = '';
        console.log('–¢–∞–±–ª–∏—Ü–∞ –æ—á–∏—â–µ–Ω–∞');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º URL
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('sort_by', sortField);
    currentUrl.searchParams.set('sort_order', newSortOrder);
    window.history.replaceState({}, '', currentUrl.toString());
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
    updateSortIndicators(sortField, newSortOrder);
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å —Å–∫—Ä–æ–ª–ª–∞
    console.log('–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å —Å–∫—Ä–æ–ª–ª–∞...');
    restoreScrollObserver();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–Ω–æ–≤–æ
    console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–Ω–æ–≤–æ...');
    loadMoreData();
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
function updateSortIndicators(sortBy, sortOrder) {
    const table = document.querySelector('.routes-table');
    if (!table) return;
    
    const headers = table.querySelectorAll('th.sortable');
    headers.forEach(header => {
        header.classList.remove('sort-asc', 'sort-desc');
    });
    
    const currentHeader = table.querySelector(`th[data-sort="${sortBy}"]`);
    if (currentHeader) {
        currentHeader.classList.add(sortOrder === 'asc' ? 'sort-asc' : 'sort-desc');
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
function showLoadingIndicator() {
    const loadingIndicator = document.getElementById('loading-indicator');
    if (loadingIndicator) {
        loadingIndicator.classList.add('show');
    }
}

function hideLoadingIndicator() {
    const loadingIndicator = document.getElementById('loading-indicator');
    if (loadingIndicator) {
        loadingIndicator.classList.remove('show');
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
function updateCounters() {
    const loadedCountElement = document.getElementById('loaded-count');
    const totalCountElement = document.getElementById('total-count');
    
    if (loadedCountElement) loadedCountElement.textContent = loadedData.length;
    if (totalCountElement) totalCountElement.textContent = totalCount;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—é...');
    
    // –ü—ã—Ç–∞–µ–º—Å—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—é
    if (!initializeVirtualization()) {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—é');
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫—Ä–æ–ª–ª–∞
    const tableContainer = document.querySelector('.routes-table-container');
    if (tableContainer) {
        tableContainer.addEventListener('scroll', function() {
            const scrollTop = tableContainer.scrollTop;
            const scrollHeight = tableContainer.scrollHeight;
            const clientHeight = tableContainer.clientHeight;
            
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–∫—Ä—É—Ç–∏–ª –¥–æ 80% –æ—Ç –∫–æ–Ω—Ü–∞
            if (scrollTop + clientHeight >= scrollHeight * 0.8) {
                console.log('–†–µ–∑–µ—Ä–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫—Ä–æ–ª–ª–∞: –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...');
                if (hasMoreData && !isLoading) {
                    loadMoreData();
                }
            }
        });
        console.log('–†–µ–∑–µ—Ä–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫—Ä–æ–ª–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω');
    }
});

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('load', function() {
    console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å –ª–∏ –¥–∞–Ω–Ω—ã–µ
    const tbody = document.getElementById('virtual-tbody');
    if (tbody && tbody.children.length === 0 && !isLoading) {
        console.log('–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
        setTimeout(() => {
            if (!initializeVirtualization()) {
                console.error('–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å');
            }
        }, 1000);
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
window.addEventListener('error', function(event) {
    console.error('JavaScript –æ—à–∏–±–∫–∞:', event.error);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–∏—Å–æ–≤
window.addEventListener('unhandledrejection', function(event) {
    console.error('–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–º–∏—Å–∞:', event.reason);
});
</script>

{% endblock %} 