{% extends "admin_routes_main.html" %}
{% block routes_content %}

<style>
.routes-header {
    margin-bottom: 12px;
}

.routes-header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.routes-title {
    font-size: 1.2em;
    color: #4f5bd5;
    margin-bottom: 6px;
    font-weight: 600;
}

.routes-description {
    color: #666;
    margin: 0;
    font-size: 0.9em;
    line-height: 1.4;
}



.routes-table-container {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(60,60,120,0.04);
    overflow-x: auto;
    margin-bottom: 16px;
    max-width: 100%;
}

.routes-table {
    width: 100%;
    min-width: 1400px;
    border-collapse: collapse;
    font-size: 0.9em;
}

.routes-table th {
    background: #f8f9ff;
    color: #4f5bd5;
    font-weight: 600;
    padding: 12px 16px;
    text-align: left;
    border-bottom: 2px solid #e0e7ff;
    font-size: 0.85em;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: background-color 0.2s;
    position: relative;
    white-space: nowrap;
}

.routes-table th:hover {
    background: #e8f0ff;
}

.routes-table th.sortable::after {
    content: '‚Üï';
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.8em;
    opacity: 0.5;
}

.routes-table th.sort-asc::after {
    content: '‚Üë';
    opacity: 1;
}

.routes-table th.sort-desc::after {
    content: '‚Üì';
    opacity: 1;
}

.routes-table td {
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    color: #3a3a4a;
}

.routes-table tr:hover {
    background: #f8f9ff;
}

.route-id {
    font-weight: 600;
    color: #4f5bd5;
    font-family: 'Courier New', monospace;
}

.route-composition {
    font-weight: 500;
    color: #43A047;
}

.route-time {
    font-family: 'Courier New', monospace;
    color: #666;
}

.route-costs {
    font-weight: 600;
    color: #e53935;
}

.route-score {
    font-weight: 500;
    color: #4f5bd5;
}

.route-level {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.8em;
    font-weight: 500;
    text-align: center;
}

.route-level-high {
    background: #e8f5e8;
    color: #43A047;
}

.route-level-medium {
    background: #fff3e0;
    color: #ff9800;
}

.route-level-low {
    background: #ffebee;
    color: #e53935;
}

.route-last-check {
    font-size: 0.8em;
    color: #999;
    font-style: italic;
}

.no-routes {
    text-align: center;
    padding: 40px;
    color: #666;
}

.no-routes-icon {
    font-size: 2em;
    margin-bottom: 16px;
    opacity: 0.5;
}

.pagination {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    margin-top: 16px;
}

.pagination-info {
    font-size: 0.9em;
    color: #666;
}

.pagination-controls {
    display: flex;
    gap: 8px;
    align-items: center;
}

.pagination-dots {
    padding: 8px 12px;
    color: #666;
}

.pagination-btn {
    padding: 8px 12px;
    border: 1px solid #e0e7ff;
    background: #fff;
    color: #4f5bd5;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9em;
}

.pagination-btn:hover {
    background: #f8f9ff;
}

.pagination-btn.active {
    background: #4f5bd5;
    color: #fff;
    border-color: #4f5bd5;
}

.pagination-btn:disabled {
    background: #f5f5f5;
    color: #ccc;
    cursor: not-allowed;
    border-color: #f0f0f0;
}


</style>

<div class="routes-header">
    <div class="routes-header-content">
        <div>
            <h2 class="routes-title">–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã —Ñ–µ—Å—Ç–∏–≤–∞–ª—è</h2>
            <p class="routes-description">–¢–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤, –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –±–∏–ª–µ—Ç–æ–≤ –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤.</p>
        </div>
    </div>
</div>

{% if routes_count and routes_count > 0 %}
    {% if routes_data and routes_data|length > 0 %}
<div class="routes-table-container">
    <table class="routes-table">
        <thead>
            <tr>
                <th class="sortable" data-sort="id">ID</th>
                <th class="sortable" data-sort="composition">–°–æ—Å—Ç–∞–≤</th>
                <th class="sortable" data-sort="days" title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π">üìÖ</th>
                <th class="sortable" data-sort="concerts" title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤">üéµ</th>
                <th class="sortable" data-sort="halls" title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ª–æ–≤">üèõÔ∏è</th>
                <th class="sortable" data-sort="genre" title="–ñ–∞–Ω—Ä">üé≠</th>
                <th class="sortable" data-sort="show_time" title="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Ü–µ—Ä—Ç–∞">‚è±Ô∏è</th>
                <th class="sortable" data-sort="trans_time" title="–í—Ä–µ–º—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤">üö∂</th>
                <th class="sortable" data-sort="wait_time" title="–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è">‚è≥</th>
                <th class="sortable" data-sort="costs" title="–°—Ç–æ–∏–º–æ—Å—Ç—å">üí∞</th>
                <th class="sortable" data-sort="comfort_score" title="–û—Ü–µ–Ω–∫–∞ –∫–æ–º—Ñ–æ—Ä—Ç–∞">üòå</th>
                <th class="sortable" data-sort="comfort_level" title="–£—Ä–æ–≤–µ–Ω—å –∫–æ–º—Ñ–æ—Ä—Ç–∞">–£—Ä–æ–≤–µ–Ω—å</th>
                <th class="sortable" data-sort="intellect_score" title="–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞">üß†</th>
                <th class="sortable" data-sort="intellect_category" title="–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for route in routes_data %}
            <tr>
                <td class="route-id">{{ route.id }}</td>
                <td class="route-composition" data-sort="{{ route.composition_count }}">{{ route.composition }}</td>
                <td data-sort="{{ route.days }}">{{ route.days }}</td>
                <td data-sort="{{ route.concerts }}">{{ route.concerts }}</td>
                <td data-sort="{{ route.halls }}">{{ route.halls }}</td>
                <td data-sort="{{ route.genre }}">{{ route.genre }}</td>
                <td class="route-time" data-sort="{{ route.show_time }}">{{ route.show_time_display }}</td>
                <td class="route-time" data-sort="{{ route.trans_time }}">{{ route.trans_time_display }}</td>
                <td class="route-time" data-sort="{{ route.wait_time }}">{{ route.wait_time_display }}</td>
                <td class="route-costs" data-sort="{{ route.costs }}">{{ route.costs_display }}</td>
                <td class="route-score" data-sort="{{ route.comfort_score }}">{{ route.comfort_score_display }}</td>
                <td data-sort="{{ route.comfort_level }}">
                    {% if route.comfort_level == 'High' %}
                        <span class="route-level route-level-high">–í—ã—Å–æ–∫–∏–π</span>
                    {% elif route.comfort_level == 'Medium' %}
                        <span class="route-level route-level-medium">–°—Ä–µ–¥–Ω–∏–π</span>
                    {% elif route.comfort_level == 'Low' %}
                        <span class="route-level route-level-low">–ù–∏–∑–∫–∏–π</span>
                    {% else %}
                        <span class="route-level">{{ route.comfort_level }}</span>
                    {% endif %}
                </td>
                <td class="route-score" data-sort="{{ route.intellect_score }}">{{ route.intellect_score_display }}</td>
                <td data-sort="{{ route.intellect_category }}">{{ route.intellect_category }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if pagination and pagination.total_pages > 1 %}
<div class="pagination">
    <div class="pagination-info">
        –ü–æ–∫–∞–∑–∞–Ω–æ {{ pagination.start_item }}-{{ pagination.end_item }} –∏–∑ {{ pagination.total_count }} –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
    </div>
    <div class="pagination-controls">
        <button class="pagination-btn" onclick="changePage({{ pagination.current_page - 1 }})" 
                {% if pagination.current_page <= 1 %}disabled{% endif %}>
            ‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è
        </button>
        
        {% set start_page = [1, pagination.current_page - 2] | max %}
        {% set end_page = [pagination.total_pages, pagination.current_page + 2] | min %}
        
        {% if start_page > 1 %}
            <button class="pagination-btn" onclick="changePage(1)">1</button>
            {% if start_page > 2 %}
                <span class="pagination-dots">...</span>
            {% endif %}
        {% endif %}
        
        {% for page_num in range(start_page, end_page + 1) %}
            <button class="pagination-btn {% if page_num == pagination.current_page %}active{% endif %}" 
                    onclick="changePage({{ page_num }})">
                {{ page_num }}
            </button>
        {% endfor %}
        
        {% if end_page < pagination.total_pages %}
            {% if end_page < pagination.total_pages - 1 %}
                <span class="pagination-dots">...</span>
            {% endif %}
            <button class="pagination-btn" onclick="changePage({{ pagination.total_pages }})">
                {{ pagination.total_pages }}
            </button>
        {% endif %}
        
        <button class="pagination-btn" onclick="changePage({{ pagination.current_page + 1 }})" 
                {% if pagination.current_page >= pagination.total_pages %}disabled{% endif %}>
            –°–ª–µ–¥—É—é—â–∞—è ‚Üí
        </button>
    </div>
</div>
{% endif %}

    {% else %}
    <div class="no-routes">
        <div class="no-routes-icon">üó∫Ô∏è</div>
        <div style="font-size: 1.2em; margin-bottom: 8px;">–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        <div style="color: #999; margin-bottom: 16px;">
            –í–æ–∑–º–æ–∂–Ω–æ, –≤—Å–µ –∫–æ–Ω—Ü–µ—Ä—Ç—ã –≤ –º–∞—Ä—à—Ä—É—Ç–∞—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –∏–ª–∏ –º–∞—Ä—à—Ä—É—Ç—ã –Ω–µ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.
        </div>
        <div style="font-size: 0.9em; color: #666;">
            <a href="/admin/routes/upload" style="color: #4f5bd5; text-decoration: none;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã</a> | 
            <a href="/admin/routes/concerts" style="color: #4f5bd5; text-decoration: none;">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤</a>
        </div>
    </div>
    {% endif %}
{% else %}
<div class="no-routes">
    <div class="no-routes-icon">üó∫Ô∏è</div>
    <div style="font-size: 1.2em; margin-bottom: 8px; color: #e53935;">–ú–∞—Ä—à—Ä—É—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>
    <div style="color: #999; margin-bottom: 16px;">
        –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å –º–∞—Ä—à—Ä—É—Ç–∞–º–∏.
    </div>
    <div style="font-size: 0.9em; color: #666;">
        <a href="/admin/routes/upload" style="color: #4f5bd5; text-decoration: none;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã</a>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É...');
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ
    const table = document.querySelector('.routes-table');
    console.log('–¢–∞–±–ª–∏—Ü–∞ –Ω–∞–π–¥–µ–Ω–∞:', !!table);
    
    if (!table) {
        console.error('–¢–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
        return;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentSortBy = urlParams.get('sort_by') || 'concerts';
    const currentSortOrder = urlParams.get('sort_order') || 'desc'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é
    
    console.log('–¢–µ–∫—É—â–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:', { sortBy: currentSortBy, sortOrder: currentSortOrder });
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–æ–ª–æ–Ω–∫–∏
    updateSortIndicators(currentSortBy, currentSortOrder);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    const headers = table.querySelectorAll('th.sortable');
    console.log('–ù–∞–π–¥–µ–Ω–æ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏:', headers.length);
    
    headers.forEach((header, index) => {
        const sortField = header.getAttribute('data-sort');
        console.log(`–ó–∞–≥–æ–ª–æ–≤–æ–∫ ${index}: data-sort="${sortField}"`);
        
        header.addEventListener('click', function() {
            console.log('–ö–ª–∏–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É:', sortField);
            changeSort(sortField);
        });
    });
    
    function changeSort(sortField) {
        console.log('–§—É–Ω–∫—Ü–∏—è changeSort –≤—ã–∑–≤–∞–Ω–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º:', sortField);
        
        const currentUrl = new URL(window.location);
        const currentSortBy = currentUrl.searchParams.get('sort_by');
        const currentSortOrder = currentUrl.searchParams.get('sort_order');
        
        console.log('–¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL:', { sortBy: currentSortBy, sortOrder: currentSortOrder });
        
        let newSortOrder = 'desc'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é
        if (currentSortBy === sortField) {
            // –ï—Å–ª–∏ –∫–ª–∏–∫–∞–µ–º –ø–æ —Ç–æ–π –∂–µ –∫–æ–ª–æ–Ω–∫–µ, –º–µ–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫
            newSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
        }
        
        console.log('–ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏:', { sortBy: sortField, sortOrder: newSortOrder });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL
        currentUrl.searchParams.set('sort_by', sortField);
        currentUrl.searchParams.set('sort_order', newSortOrder);
        currentUrl.searchParams.set('page', '1'); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        
        const newUrl = currentUrl.toString();
        console.log('–ü–µ—Ä–µ—Ö–æ–¥–∏–º –ø–æ URL:', newUrl);
        
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        window.location.href = newUrl;
    }
    
    function updateSortIndicators(sortBy, sortOrder) {
        console.log('–û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏:', { sortBy, sortOrder });
        
        // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        const headers = table.querySelectorAll('th.sortable');
        headers.forEach(header => {
            header.classList.remove('sort-asc', 'sort-desc');
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–æ–ª–æ–Ω–∫–∏
        const currentHeader = table.querySelector(`th[data-sort="${sortBy}"]`);
        if (currentHeader) {
            currentHeader.classList.add(sortOrder === 'asc' ? 'sort-asc' : 'sort-desc');
            console.log('–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏:', sortBy);
        } else {
            console.warn('–ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω:', sortBy);
        }
    }
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–º–µ–Ω—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
function changePage(page) {
    console.log('–°–º–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞:', page);
    if (page < 1) return;
    
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('page', page);
    window.location.href = currentUrl.toString();
}
</script>

{% endblock %} 