<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Figaro — конструктор маршрутов фестиваля «Безумные дни в Екатеринбурге»</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            max-width: 1100px;
            margin: 40px auto 0 auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 36px;
            padding: 48px 40px 36px 40px;
            box-shadow: 0 8px 32px rgba(102,126,234,0.13);
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
        }
        
        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .user-section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .user-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .auth-section {
            text-align: center;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .auth-section h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .auth-links {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        .auth-links a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .auth-links a:hover {
            background: #667eea;
            color: white;
        }
        
        .content-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-top: 30px;
        }
        
        .content-section h2 {
            color: #333;
            margin-bottom: 20px;
        }
        
        /* Стили для анкеты */
        .survey-section {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-top: 30px;
        }
        
        .survey-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .survey-header h2 {
            font-size: 2.2em;
            color: #333;
            margin: 0 0 10px 0;
        }
        
        .survey-header p {
            color: #666;
            font-size: 1.1em;
            margin: 0;
        }
        
        .survey-form {
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* Прогресс-бар */
        .survey-progress {
            margin-bottom: 40px;
            text-align: center;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 20%;
        }
        
        .progress-text {
            color: #666;
            font-size: 0.9em;
            font-weight: 500;
        }
        
        /* Слайды */
        .survey-slide {
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        .survey-slide.active {
            display: block;
        }
        
        .slide-content {
            text-align: center;
        }
        
        .slide-title {
            font-size: 1.8em;
            color: #333;
            margin: 0 0 15px 0;
            font-weight: 600;
        }
        
        .slide-description {
            color: #666;
            font-size: 1.1em;
            margin: 0 0 40px 0;
            line-height: 1.5;
        }
        
        .form-group {
            margin-bottom: 40px;
        }
        
        .form-label {
            display: block;
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .radio-group.compact {
            flex-direction: row;
            justify-content: space-between;
        }
        
        .radio-option {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .radio-option:hover .radio-content {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102,126,234,0.15);
        }
        
        .radio-input {
            display: none;
        }
        
        .radio-content {
            display: flex;
            align-items: center;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            transition: all 0.2s ease;
            background: #fafafa;
        }
        
        .radio-input:checked + .radio-content {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
            box-shadow: 0 4px 20px rgba(102,126,234,0.1);
        }
        
        .radio-icon {
            font-size: 2em;
            margin-right: 16px;
            min-width: 40px;
            text-align: center;
        }
        
        .radio-number {
            font-size: 1.8em;
            font-weight: 700;
            color: #667eea;
            margin-right: 16px;
            min-width: 40px;
            text-align: center;
        }
        
        .radio-text {
            flex: 1;
        }
        
        .radio-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .radio-description {
            color: #666;
            font-size: 0.9em;
        }
        
        .radio-option.compact .radio-content {
            flex-direction: column;
            text-align: center;
            padding: 16px 12px;
            min-width: 100px;
        }
        
        .radio-option.compact .radio-number {
            margin-right: 0;
            margin-bottom: 8px;
        }
        
        .preferences-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .preference-field {
            display: flex;
            flex-direction: column;
        }
        
        .preference-field label {
            font-weight: 500;
            color: #555;
            margin-bottom: 8px;
        }
        
        .form-input {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.2s ease;
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        .form-input::placeholder {
            color: #9ca3af;
        }
        
        /* Навигация */
        .survey-navigation {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 40px;
            align-items: center;
        }
        
        .btn-prev, .btn-next {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-prev:hover, .btn-next:hover {
            background: #667eea;
            color: white;
        }
        
        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(102,126,234,0.3);
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102,126,234,0.4);
        }
        
        .btn-skip {
            background: transparent;
            color: #666;
            border: 2px solid #e5e7eb;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-skip:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        /* Анимации */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Облако тегов */
        .tag-cloud {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            gap: 8px;
            margin: 0 auto;
            width: 100%;
        }
        
        .tag {
            background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
            border: 2px solid #c7d2fe;
            border-radius: 12px;
            padding: 4px 10px;
            margin: 0;
            font-size: 0.9em;
            display: inline-block;
            line-height: 1.2;
            white-space: nowrap;
            font-weight: 500;
            color: #4f5bd5;
            cursor: pointer;
            user-select: none;
            transition: background 0.15s, border 0.15s;
        }
        
        .tag:hover {
            background: #e0e7ff;
            border-color: #667eea;
        }
        
        .tag.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }
        
        .loading {
            color: #666;
            font-style: italic;
        }
        
        .selected-tags {
            text-align: center;
            margin-top: 15px;
        }
        
        .selected-count {
            background: rgba(102,126,234,0.1);
            color: #667eea;
            padding: 6px 12px;
            border-radius: 16px;
            font-weight: 500;
            font-size: 0.9em;
        }
        
        /* Резюме */
        .summary-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .summary-section {
            background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
            border: 2px solid #e0e7ff;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .summary-section h4 {
            margin: 0 0 15px 0;
            color: #4f5bd5;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .summary-item {
            background: white;
            border: 1px solid #e0e7ff;
            border-radius: 8px;
            padding: 12px;
            color: #333;
            font-weight: 500;
            min-height: 20px;
        }
        
        .summary-item.empty {
            color: #9ca3af;
            font-style: italic;
        }
        
        .summary-item.tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }
        
        .summary-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        /* Модальное окно с сохраненными предпочтениями */
        .saved-preferences-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }
        
        .saved-preferences-modal {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        .saved-preferences-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .saved-preferences-header h2 {
            color: #4f5bd5;
            margin: 0 0 10px 0;
            font-size: 1.8em;
        }
        
        .saved-preferences-header p {
            color: #6b7280;
            margin: 0;
            font-size: 1.1em;
        }
        
        .saved-preferences-content {
            margin-bottom: 30px;
        }
        
        .preferences-summary {
            background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
            border: 2px solid #e0e7ff;
            border-radius: 12px;
            padding: 20px;
        }
        
        .preference-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e0e7ff;
        }
        
        .preference-item:last-child {
            border-bottom: none;
        }
        
        .preference-label {
            font-weight: 600;
            color: #4f5bd5;
        }
        
        .preference-value {
            color: #333;
            font-weight: 500;
        }
        
        .saved-preferences-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn-use-preferences {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }
        
        .btn-use-preferences:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn-reset-preferences {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }
        
        .btn-reset-preferences:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.3);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Сообщение об авторизации */
        .auth-message-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }
        
        .auth-message-modal {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        .auth-message-header h2 {
            color: #4f5bd5;
            margin: 0 0 15px 0;
            font-size: 1.8em;
        }
        
        .auth-message-header p {
            color: #6b7280;
            margin: 0 0 30px 0;
            font-size: 1.1em;
        }
        
        .auth-message-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .btn-login, .btn-register {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 1em;
        }
        
        .btn-login:hover, .btn-register:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn-continue-anonymous {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }
        
        .btn-continue-anonymous:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.3);
        }
        
        @media (max-width: 768px) {
            .survey-section {
                padding: 20px;
            }
            
            .radio-group.compact {
                flex-direction: column;
            }
            
            .preferences-grid {
                grid-template-columns: 1fr;
            }
            
            .survey-navigation {
                flex-direction: column;
            }
            
            .slide-title {
                font-size: 1.5em;
            }
            
            .exclusions-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .tag-cloud {
                gap: 6px;
            }
            
            .tag {
                padding: 4px 10px;
                font-size: 0.85em;
            }
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `
        .reset-survey-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 10px 22px; font-weight: 600; cursor: pointer; margin-bottom: 18px; margin-right: 12px; float: right; transition: background 0.2s; }
        .reset-survey-btn:hover { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
        `;
        if (!document.getElementById('reset-btn-styles')) {
            const style = document.createElement('style');
            style.id = 'reset-btn-styles';
            style.innerHTML = resetBtnStyles;
            document.head.appendChild(style);
        }

        .tabs-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 0 0 40px 0;
        }
        .tabs { display: flex; border-bottom: 2px solid #e0e7ff; }
        .tab-btn { flex: 1; padding: 18px 0; background: none; border: none; font-size: 1.2em; font-weight: 600; color: #4f5bd5; cursor: pointer; transition: background 0.2s; border-radius: 18px 18px 0 0; }
        .tab-btn.active { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); color: #222; }
        .tab-content { padding: 30px 40px 0 40px; }
        .recommendations-block { margin-top: 0; }
        .rec-group { margin-bottom: 36px; }
        .rec-group h3 { color: #4f5bd5; margin-bottom: 18px; font-size: 1.15em; }
        .rec-list { display: flex; flex-wrap: wrap; gap: 18px; }
        .rec-route { background: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; padding: 18px 22px; min-width: 220px; max-width: 320px; flex: 1 1 220px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); font-size: 1em; display: flex; flex-direction: column; gap: 8px; }
        .rec-title { font-weight: 700; font-size: 1.1em; margin-bottom: 4px; color: #4f5bd5; }
        .rec-meta { color: #333; font-size: 1em; }
        .rec-scores { display: flex; gap: 10px; margin: 4px 0; }
        .score-intellect { color: #3b82f6; font-weight: 600; }
        .score-comfort { color: #10b981; font-weight: 600; }
        .score-weighted { color: #f59e42; font-weight: 600; }
        .rec-details { display: flex; gap: 10px; color: #6b7280; font-size: 0.98em; }
        .rec-details-btn { margin-top: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        .route-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .route-modal { background: #fff; border-radius: 16px; padding: 32px 36px; max-width: 420px; width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; }
        .route-modal h3 { margin-top: 0; color: #4f5bd5; }
        .route-modal-list { margin: 18px 0 24px 0; padding-left: 18px; }
        .route-modal-close { background: #e0e7ff; color: #4f5bd5; border: none; border-radius: 8px; padding: 8px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .route-modal-close:hover { background: #c7d2fe; }
        `;
        if (!document.getElementById('rec-card-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-card-styles';
            style.innerHTML = recCardStyles;
            document.head.appendChild(style);
        }

        // Стили для спиннера
        const recSpinnerStyles = `
        .recommendations-block { position: relative; min-height: 220px; }
        .recs-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; font-size: 1.1em; color: #4f5bd5; background: rgba(255,255,255,0.85); z-index: 2; }
        .spinner { width: 38px; height: 38px; border: 5px solid #e0e7ff; border-top: 5px solid #667eea; border-radius: 50%; box-shadow: 0 2px 12px rgba(102,126,234,0.10); animation: spin 1.3s cubic-bezier(0.4,0.2,0.2,1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        if (!document.getElementById('rec-spinner-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-spinner-styles';
            style.innerHTML = recSpinnerStyles;
            document.head.appendChild(style);
        }

        .header-title {
            color: #fff;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 0.2em;
        }
        .header-subtitle {
            color: #f3f4fa;
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 1.2em;
        }

        function renderGroup(title, routes, groupType) {
            if (!routes || !routes.length) return '';
            // Выбираем топ-3 по главному параметру группы
            let sorted = [...routes];
            if (groupType === 'weighted') {
                sorted.sort((a, b) => (b.weighted || 0) - (a.weighted || 0));
            } else if (groupType === 'intellect') {
                sorted.sort((a, b) => (b.intellect || 0) - (a.intellect || 0));
            } else if (groupType === 'comfort') {
                sorted.sort((a, b) => (b.comfort || 0) - (a.comfort || 0));
            } else if (groupType === 'balanced') {
                sorted.sort((a, b) => Math.abs((b.intellect || 0) - (b.comfort || 0)) - Math.abs((a.intellect || 0) - (a.comfort || 0)));
            }
            const top3 = sorted.slice(0, 3);
            return `
                <div class="rec-group">
                    <h3>${title}</h3>
                    <div class="rec-table-wrapper">
                        <table class="rec-table">
                            <thead>
                                <tr>
                                    <th>Маршрут</th>
                                    <th>Концерты</th>
                                    <th>Состав</th>
                                    <th>🧠</th>
                                    <th>🛋️</th>
                                    <th>🎯</th>
                                    <th>🚶</th>
                                    <th>⏱️</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${top3.map(renderRouteRow).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRouteRow(route) {
            let concertsList = '-';
            let concertsArr = [];
            if (route.concerts) {
                if (Array.isArray(route.concerts)) {
                    concertsArr = route.concerts.map(x => +x).sort((a, b) => a - b);
                } else if (typeof route.concerts === 'string') {
                    concertsArr = route.concerts.split(',').map(x => +x).sort((a, b) => a - b);
                }
                concertsList = concertsArr.join(', ');
            }
            return `
                <tr>
                    <td class="rec-table-title">#${route.id}</td>
                    <td>${route.concerts_count}</td>
                    <td>${concertsList}</td>
                    <td class="score-intellect">${route.intellect}</td>
                    <td class="score-comfort">${route.comfort}</td>
                    <td class="score-weighted">${route.weighted !== null && route.weighted !== undefined ? route.weighted.toFixed(1) : ''}</td>
                    <td>${route.trans_time} мин</td>
                    <td>${route.wait_time} мин</td>
                    <td><button class="rec-details-btn" onclick="showRouteDetails(${route.id}, '${concertsArr.join(',')}')">Подробнее</button></td>
                </tr>
            `;
        }

        // Стили для таблицы
        const recTableStyles = `
        .rec-table-wrapper { overflow-x: auto; }
        .rec-table { width: 100%; border-collapse: collapse; margin: 0 0 24px 0; background: #f8faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .rec-table th, .rec-table td { padding: 10px 12px; text-align: center; }
        .rec-table th { background: #e0e7ff; color: #4f5bd5; font-weight: 700; }
        .rec-table-title { font-weight: 700; color: #4f5bd5; }
        .rec-table tr:nth-child(even) { background: #f3f4fa; }
        .rec-details-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 7px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .rec-details-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6c3483 100%); }
        `;
        if (!document.getElementById('rec-table-styles')) {
            const style = document.createElement('style');
            style.id = 'rec-table-styles';
            style.innerHTML = recTableStyles;
            document.head.appendChild(style);
        }

        // Добавим кнопку сброса анкеты на вкладке Анкета
        const surveySection = document.getElementById('user-survey');
        if (surveySection && !document.getElementById('reset-survey-btn')) {
            const resetBtn = document.createElement('button');
            resetBtn.id = 'reset-survey-btn';
            resetBtn.className = 'reset-survey-btn';
            resetBtn.innerText = 'Сбросить анкету';
            resetBtn.onclick = function() { resetSurvey(); };
            surveySection.insertAdjacentElement('afterbegin', resetBtn);
        }

        function resetSurvey() {
            // Сбросить все выбранные значения
            document.querySelectorAll('input[type="radio"]').forEach(input => { input.checked = false; });
            selectedComposers.clear();
            selectedArtists.clear();
            selectedConcerts.clear();
            // Вернуться на первый слайд
            hideSlide(currentStep);
            currentStep = 1;
            showSlide(currentStep);
            updateProgress();
            updateNavigation();
            updateTagClouds();
            updateSummary();
        }

        // Стили для кнопки сброса
        const resetBtnStyles = `