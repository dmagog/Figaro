<!DOCTYPE html>
<html>
<head>
    <title>Тест скролла</title>
    <style>
        .test-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 20px;
        }
        .scroll-sentinel {
            height: 20px;
            background: red;
            margin: 20px 0;
        }
        .test-item {
            padding: 10px;
            margin: 5px 0;
            background: #f0f0f0;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>Тест скролла</h1>
    <div class="test-container" id="test-container">
        <div class="test-item">Элемент 1</div>
        <div class="test-item">Элемент 2</div>
        <div class="test-item">Элемент 3</div>
        <div class="test-item">Элемент 4</div>
        <div class="test-item">Элемент 5</div>
        <div class="test-item">Элемент 6</div>
        <div class="test-item">Элемент 7</div>
        <div class="test-item">Элемент 8</div>
        <div class="test-item">Элемент 9</div>
        <div class="test-item">Элемент 10</div>
        <div class="test-item">Элемент 11</div>
        <div class="test-item">Элемент 12</div>
        <div class="test-item">Элемент 13</div>
        <div class="test-item">Элемент 14</div>
        <div class="test-item">Элемент 15</div>
        <div class="test-item">Элемент 16</div>
        <div class="test-item">Элемент 17</div>
        <div class="test-item">Элемент 18</div>
        <div class="test-item">Элемент 19</div>
        <div class="test-item">Элемент 20</div>
        <div class="scroll-sentinel" id="scroll-sentinel">SCROLL SENTINEL</div>
    </div>
    
    <div id="debug-info" style="margin-top: 20px; padding: 10px; background: #f9f9f9;">
        <h3>Отладочная информация:</h3>
        <div id="debug-content"></div>
    </div>

    <script>
        let observer = null;
        let debugCount = 0;
        
        function log(message) {
            const debugContent = document.getElementById('debug-content');
            debugCount++;
            const timestamp = new Date().toLocaleTimeString();
            debugContent.innerHTML += `<div>[${timestamp}] ${debugCount}: ${message}</div>`;
            console.log(message);
        }
        
        function initObserver() {
            log('Инициализация наблюдателя...');
            
            const scrollSentinel = document.getElementById('scroll-sentinel');
            if (!scrollSentinel) {
                log('ERROR: scroll-sentinel не найден!');
                return false;
            }
            
            if (observer) {
                observer.disconnect();
                log('Предыдущий наблюдатель отключен');
            }
            
            observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    log(`IntersectionObserver: isIntersecting=${entry.isIntersecting}`);
                    if (entry.isIntersecting) {
                        log('Scroll sentinel видим! Загружаем данные...');
                        loadMoreData();
                    }
                });
            });
            
            observer.observe(scrollSentinel);
            log('Наблюдатель установлен на scroll-sentinel');
            return true;
        }
        
        function loadMoreData() {
            log('Загрузка дополнительных данных...');
            // Симулируем загрузку
            setTimeout(() => {
                const container = document.getElementById('test-container');
                const sentinel = document.getElementById('scroll-sentinel');
                
                // Добавляем новые элементы перед sentinel
                for (let i = 0; i < 5; i++) {
                    const newItem = document.createElement('div');
                    newItem.className = 'test-item';
                    newItem.textContent = `Новый элемент ${Date.now()}`;
                    container.insertBefore(newItem, sentinel);
                }
                
                log('Добавлено 5 новых элементов');
            }, 500);
        }
        
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            log('DOM загружен');
            initObserver();
            
            // Добавляем обработчик скролла как резервный вариант
            const container = document.getElementById('test-container');
            container.addEventListener('scroll', function() {
                const scrollTop = container.scrollTop;
                const scrollHeight = container.scrollHeight;
                const clientHeight = container.clientHeight;
                
                log(`Скролл: ${scrollTop}/${scrollHeight - clientHeight} (${Math.round(scrollTop / (scrollHeight - clientHeight) * 100)}%)`);
                
                if (scrollTop + clientHeight >= scrollHeight - 50) {
                    log('Резервный обработчик: конец скролла достигнут');
                    loadMoreData();
                }
            });
        });
    </script>
</body>
</html> 